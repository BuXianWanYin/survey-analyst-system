# 问卷统计功能集成文档

## 一、功能概述

本文档说明如何将问卷星的统计功能集成到项目中，实现完善的问卷统计分析功能。

### 1.1 需要实现的功能

✅ **保留功能：**
- 统计报告展示（默认报告、分类统计、交叉分析）
- 题目统计展示（统计表格、多种图表类型：饼状、圆环、柱状、折线、条形、表格）
- 数据导出功能（分享报告、下载报告、PDF导出、Excel导出）
- 显示设置（数据表格显示、图表类型选择、隐藏选项、配色方案）
- 数据筛选功能（分类筛选）

❌ **不需要的功能：**
- AI智能分析
- 图表交互的打印
- 保存图片
- 放大/缩小
- 对比分析
- 自定义查询
- SPSS分析

---

## 二、功能模块设计

### 2.1 页面结构

```
统计页面
├── 顶部工具栏
│   ├── 分享报告
│   ├── 下载报告
│   ├── PDF导出
│   ├── Excel导出
│   └── 显示设置
│
├── 标签页切换
│   ├── 统计视图（即默认报告）
│   ├── 分类统计
│   └── 数据分析（即交叉/对比分析）
│
└── 内容区域
    ├── 问卷整体统计卡片
    └── 各题目统计卡片
        ├── 统计表格
        ├── 图表切换（饼状/圆环/柱状/折线/条形/表格）
        └── 配色方案选择
```

### 2.2 数据流

```
前端请求 → 统一接口 getAllStatistics
         ↓
后端统计服务 → 获取所有数据
         ↓
返回数据结构：
{
  surveyStatistics: { ... },          // 问卷整体统计
  questionStatistics: {               // 各题目统计
    formItemId1: { ... },
    formItemId2: { ... }
  }
}
```

---

## 三、功能详细设计

### 3.1 默认报告

**功能说明：**
- 显示所有题目的完整统计信息
- 每个题目显示：题目标题、题型、统计表格、图表

**展示内容：**
1. 问卷整体统计（总填写数、已完成数、草稿数、有效率）
2. 每个题目的统计数据：
   - 选择题：选项列表、选择人数、比例、条形图、饼图/柱状图等
   - 文本题：有效答案数、总答案数、词云图（可选）
   - 评分题：平均分、最高分、最低分、评分分布图
   - 数字题：平均值、最大值、最小值、有效数据数

**说明：**
- 当前页面的"统计视图"标签页即为"默认报告"功能
- 文本题（填空题）可以考虑使用词云图可视化展示高频词汇

**实现要点：**
- 使用统一接口 `getAllStatistics` 一次性获取所有数据
- 根据题目类型选择不同的展示方式

---

### 3.2 分类统计

**功能说明：**
- 按题目选项进行筛选，查看特定分类的数据
- 支持单条件筛选和双条件组合筛选

**交互流程：**
1. 选择筛选条件（题目下拉框）
2. 显示该题目的选项列表
3. 点击选项，筛选出符合该选项的所有答卷
4. 更新统计图表，只显示筛选后的数据

**技术实现：**
- 前端传递筛选条件到后端
- 后端根据筛选条件过滤数据
- 返回筛选后的统计数据

**接口设计：**
```javascript
// 分类统计接口
POST /api/statistics/filter
{
  surveyId: 1,
  filters: [
    { formItemId: "input-123", optionValue: "1" },  // 单条件
    { formItemId: "radio-456", optionValue: "2" }   // 多条件（AND关系）
  ]
}
```

---

### 3.3 数据分析（交叉/对比分析）

**功能说明：**
- 数据分析标签页包含交叉分析和对比分析功能
- **交叉分析**：设置自变量 X（如性别）和因变量 Y（要分析的目标题目），分析不同 X 值下，Y 的分布差异
- **对比分析**：选择对比变量（如性别、年龄段），对比不同群体在各题目上的差异
- 支持热力图、分组柱状图等可视化展示

**交互流程：**
1. 选择分析类型（交叉分析/对比分析）
2. **交叉分析**：
   - 选择自变量 X（限2题）
   - 选择因变量 Y（限10题）
   - 点击"交叉分析"按钮
3. **对比分析**：
   - 选择对比变量（如性别）
   - 系统自动对比该变量不同值下各题目的分布
4. 显示分析结果（表格+图表）

**技术实现：**
- 使用现有的交叉分析接口
- 前端传递自变量和因变量
- 后端计算交叉统计，返回表格数据和图表数据

**接口设计：**
```javascript
// 交叉分析接口（已有）
POST /api/analysis/cross
{
  surveyId: 1,
  xVariables: ["formItemId1", "formItemId2"],  // 自变量
  yVariables: ["formItemId3", "formItemId4"]   // 因变量
}

// 对比分析接口
POST /api/analysis/compare
{
  surveyId: 1,
  compareVariable: "formItemId1"  // 对比变量（如性别）
}
```

**说明：**
- 当前页面的"数据分析"标签页即为交叉/对比分析功能
- 可以在此标签页内切换交叉分析和对比分析模式

---

### 3.4 统计表格

**功能说明：**
- 显示选项列表、选择人数、比例
- 支持条形图显示比例
- 显示"本题有效填写人次"

**表格结构：**
```
| 选项 | 小计 | 比例 |
|------|------|------|
| 选项1 | 37   | 53.62% [条形图] |
| 选项2 | 32   | 46.38% [条形图] |
| 合计  | 69   |       |
```

**实现要点：**
- 使用 Element Plus 的 `el-table` 组件
- 比例列使用自定义渲染，显示条形图

---

### 3.5 图表类型切换

**功能说明：**
- 支持多种图表类型切换：饼状、圆环、柱状、折线、条形、表格
- 图表类型按钮组位于题目卡片右上角
- 点击切换，图表实时更新

**图表类型：**
1. **饼状图** - 适合展示比例关系
2. **圆环图** - 类似饼图，中心可显示总计
3. **柱状图** - 适合对比各选项数量
4. **折线图** - 适合展示趋势（如果数据有序）
5. **条形图** - 横向柱状图，适合选项名称较长
6. **表格** - 纯表格展示，不显示图表
7. **词云图** - 用于文本题，展示高频词汇（填空题可考虑使用）

**实现要点：**
- 使用 ECharts 渲染图表
- 图表配置根据当前选择的类型动态生成
- 保存用户的图表类型偏好到 localStorage

---

### 3.6 配色方案

**功能说明：**
- 提供多种预设配色方案
- 支持应用到所有图表
- 配色方案持久化保存

**预设配色方案：**
1. **WJX默认** - 蓝绿色系
2. **深浅对比** - 深浅色搭配
3. **色彩渐变** - 渐变色系
4. **科技蓝** - 蓝色系
5. **极光绿** - 绿色系

**实现要点：**
- 配色方案作为主题配置传递给 ECharts
- 保存到用户设置或 localStorage
- 全局应用或按题目应用

---

### 3.7 显示设置

**功能说明：**
- 控制统计表格的显示/隐藏
- 控制条形图的显示/隐藏
- 控制平均分数据的显示/隐藏（针对评分题）
- 控制空选项、跳过项的显示/隐藏

**设置项：**
- ☑ 显示表格
- ☑ 表格条形图
- ☑ 平均分数据
- ☑ 隐藏空选项
- ☑ 隐藏跳过项

**实现要点：**
- 使用 Element Plus 的 Checkbox 组件
- 设置项保存到 localStorage
- 实时更新页面显示

---

### 3.8 数据导出

#### 3.8.1 分享报告

**功能说明：**
- 生成统计报告的分享链接
- 链接可设置有效期
- 支持密码保护

**实现要点：**
- 后端生成唯一分享码
- 前端生成分享链接
- 点击复制链接到剪贴板

#### 3.8.2 下载报告

**功能说明：**
- 生成完整的统计报告（Word 或 PDF 格式）
- 包含所有题目的统计数据和图表

**实现要点：**
- 后端生成报告文件
- 使用模板引擎生成 Word
- 或使用 PDF 库生成 PDF

#### 3.8.3 PDF 导出

**功能说明：**
- 将当前页面导出为 PDF
- 包含所有可见的统计内容和图表

**实现要点：**
- 使用 html2canvas 将页面转为图片
- 使用 jsPDF 将图片生成 PDF

#### 3.8.4 Excel 导出

**功能说明：**
- 导出原始答卷数据
- 或导出统计数据表格

**实现要点：**
- 后端生成 Excel 文件
- 使用 POI 或 EasyExcel
- 前端下载文件

---

## 四、技术实现

### 4.1 前端实现

#### 4.1.1 组件结构

```vue
<!-- statistics.vue -->
<template>
  <div class="statistics-container">
    <!-- 工具栏 -->
    <Toolbar 
      @share="handleShare"
      @download="handleDownload"
      @export-pdf="handleExportPDF"
      @export-excel="handleExportExcel"
      @settings="showSettingsDialog"
    />
    
    <!-- 标签页 -->
    <el-tabs v-model="activeTab">
      <el-tab-pane label="统计视图" name="chart">
        <!-- 默认报告内容直接在这里展示 -->
        <DefaultReport 
          :survey-statistics="surveyStatistics"
          :question-statistics="questionStatistics"
          :display-settings="displaySettings"
          :chart-type-map="chartTypeMap"
          :color-scheme="colorScheme"
        />
      </el-tab-pane>
      
      <el-tab-pane label="分类统计" name="filter">
        <FilterStatistics 
          :survey-id="surveyId"
          :form-items="formItems"
          @filter="handleFilter"
        />
      </el-tab-pane>
      
      <el-tab-pane label="数据分析" name="analysis">
        <!-- 交叉/对比分析 -->
        <CrossAnalysis 
          :survey-id="surveyId"
          :form-items="formItems"
        />
      </el-tab-pane>
    </el-tabs>
    
    <!-- 显示设置对话框 -->
    <SettingsDialog 
      v-model="settingsDialogVisible"
      :settings="displaySettings"
      @update="updateSettings"
    />
  </div>
</template>
```

#### 4.1.2 关键组件

**1. QuestionStatCard（题目统计卡片）**

```vue
<template>
  <el-card class="question-stat-card">
    <template #header>
      <div class="card-header">
        <div class="question-title">
          <span>第{{ index }}题：</span>
          <span>{{ question.label }}</span>
          <el-tag size="small">{{ questionTypeLabel }}</el-tag>
        </div>
        <div class="chart-type-switcher">
          <el-button-group>
            <el-button 
              v-for="type in chartTypes"
              :key="type.value"
              :type="currentChartType === type.value ? 'primary' : 'default'"
              size="small"
              @click="switchChartType(type.value)"
            >
              {{ type.label }}
            </el-button>
          </el-button-group>
        </div>
      </div>
    </template>
    
    <!-- 统计表格 -->
    <StatTable 
      v-if="showTable"
      :data="statisticsData"
      :show-bar="displaySettings.showBar"
    />
    
    <!-- 图表 -->
    <div v-if="currentChartType !== 'table'" class="chart-wrapper">
      <v-chart 
        :option="chartOption"
        :style="{ height: '300px' }"
        autoresize
      />
    </div>
  </el-card>
</template>
```

**2. ChartTypeSwitcher（图表类型切换器）**

```javascript
const chartTypes = [
  { value: 'pie', label: '饼状', icon: 'pie-chart' },
  { value: 'ring', label: '圆环', icon: 'ring-chart' },
  { value: 'bar', label: '柱状', icon: 'bar-chart' },
  { value: 'line', label: '折线', icon: 'line-chart' },
  { value: 'horizontalBar', label: '条形', icon: 'horizontal-bar' },
  { value: 'table', label: '表格', icon: 'table' }
]
```

**3. ColorSchemePicker（配色方案选择器）**

```vue
<template>
  <el-dropdown @command="changeColorScheme">
    <el-button>
      配色 <el-icon><ArrowDown /></el-icon>
    </el-button>
    <template #dropdown>
      <el-dropdown-menu>
        <el-dropdown-item 
          v-for="scheme in colorSchemes"
          :key="scheme.id"
          :command="scheme.id"
        >
          <div class="color-scheme-item">
            <div class="color-preview" :style="{ background: scheme.preview }"></div>
            <span>{{ scheme.name }}</span>
          </div>
        </el-dropdown-item>
      </el-dropdown-menu>
    </template>
  </el-dropdown>
</template>
```

#### 4.1.3 图表配置生成

```javascript
// utils/chartConfig.js

/**
 * 根据图表类型和统计数据生成 ECharts 配置
 */
export function generateChartOption(type, statistics, colorScheme) {
  const baseOption = {
    tooltip: { trigger: 'item' },
    legend: { bottom: '5%' },
    color: colorScheme.colors
  }
  
  switch (type) {
    case 'pie':
      return {
        ...baseOption,
        series: [{
          type: 'pie',
          radius: '50%',
          data: statistics.optionStats.map(opt => ({
            value: opt.count,
            name: opt.optionLabel
          }))
        }]
      }
      
    case 'ring':
      return {
        ...baseOption,
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          data: statistics.optionStats.map(opt => ({
            value: opt.count,
            name: opt.optionLabel
          }))
        }]
      }
      
    case 'bar':
      return {
        ...baseOption,
        tooltip: { trigger: 'axis' },
        xAxis: {
          type: 'category',
          data: statistics.optionStats.map(opt => opt.optionLabel)
        },
        yAxis: { type: 'value' },
        series: [{
          type: 'bar',
          data: statistics.optionStats.map(opt => opt.count)
        }]
      }
      
    case 'horizontalBar':
      return {
        ...baseOption,
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'value' },
        yAxis: {
          type: 'category',
          data: statistics.optionStats.map(opt => opt.optionLabel)
        },
        series: [{
          type: 'bar',
          data: statistics.optionStats.map(opt => opt.count)
        }]
      }
      
    case 'line':
      return {
        ...baseOption,
        tooltip: { trigger: 'axis' },
        xAxis: {
          type: 'category',
          data: statistics.optionStats.map(opt => opt.optionLabel)
        },
        yAxis: { type: 'value' },
        series: [{
          type: 'line',
          data: statistics.optionStats.map(opt => opt.count)
        }]
      }
      
    case 'wordcloud':
      // 词云图（用于文本题）
      return {
        ...baseOption,
        tooltip: {},
        series: [{
          type: 'wordCloud',
          gridSize: 2,
          sizeRange: [12, 50],
          rotationRange: [-90, 90],
          shape: 'pentagon',
          data: statistics.wordCloudData
        }]
      }
      
    default:
      return baseOption
  }
}
```

#### 4.1.4 数据导出实现

```javascript
// utils/export.js

/**
 * 导出 PDF
 */
export async function exportToPDF(element, filename = '统计报告.pdf') {
  const canvas = await html2canvas(element, {
    scale: 2,
    useCORS: true
  })
  
  const imgData = canvas.toDataURL('image/png')
  const pdf = new jsPDF('p', 'mm', 'a4')
  
  const imgWidth = 210
  const pageHeight = 297
  const imgHeight = (canvas.height * imgWidth) / canvas.width
  let heightLeft = imgHeight
  let position = 0
  
  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
  heightLeft -= pageHeight
  
  while (heightLeft > 0) {
    position = heightLeft - imgHeight
    pdf.addPage()
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
    heightLeft -= pageHeight
  }
  
  pdf.save(filename)
}

/**
 * 导出 Excel（统计数据表格）
 */
export function exportStatisticsToExcel(statistics, filename = '统计数据.xlsx') {
  const data = []
  
  // 添加问卷整体统计
  data.push(['问卷整体统计'])
  data.push(['总填写数', statistics.surveyStatistics.totalResponses])
  data.push(['已完成数', statistics.surveyStatistics.completedResponses])
  // ...
  
  // 添加各题目统计
  Object.keys(statistics.questionStatistics).forEach(formItemId => {
    const questionStat = statistics.questionStatistics[formItemId]
    data.push([])
    data.push([questionStat.questionTitle])
    data.push(['选项', '小计', '比例'])
    
    if (questionStat.optionStats) {
      questionStat.optionStats.forEach(opt => {
        data.push([opt.optionLabel, opt.count, `${opt.percentage}%`])
      })
    }
  })
  
  // 使用 xlsx 库生成 Excel
  const ws = XLSX.utils.aoa_to_sheet(data)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, '统计数据')
  XLSX.writeFile(wb, filename)
}
```

---

### 4.2 后端实现

#### 4.2.1 接口扩展

需要在现有的 `StatisticsController` 中添加以下接口：

```java
/**
 * 分类统计接口
 */
@PostMapping("/filter")
public Result<Map<String, Object>> filterStatistics(
    @RequestBody FilterRequest request) {
    // 根据筛选条件过滤数据
    Map<String, Object> statistics = statisticsService.getFilteredStatistics(
        request.getSurveyId(), 
        request.getFilters()
    );
    return Result.success(statistics);
}

/**
 * 生成统计报告（Word/PDF）
 */
@GetMapping("/report/{surveyId}")
public void generateReport(
    @PathVariable Long surveyId,
    @RequestParam(defaultValue = "word") String format,
    HttpServletResponse response) {
    // 生成报告文件
    statisticsService.generateReport(surveyId, format, response);
}

/**
 * 创建分享链接
 */
@PostMapping("/share")
public Result<ShareResponse> createShareLink(
    @RequestBody ShareRequest request) {
    String shareCode = statisticsService.createShareLink(
        request.getSurveyId(),
        request.getExpireDays(),
        request.getPassword()
    );
    return Result.success(new ShareResponse(shareCode));
}
```

#### 4.2.2 服务层扩展

```java
public interface StatisticsService {
    // ... 现有方法
    
    /**
     * 获取筛选后的统计数据
     */
    Map<String, Object> getFilteredStatistics(
        Long surveyId, 
        List<FilterCondition> filters
    );
    
    /**
     * 生成统计报告
     */
    void generateReport(
        Long surveyId, 
        String format, 
        HttpServletResponse response
    );
    
    /**
     * 创建分享链接
     */
    String createShareLink(
        Long surveyId, 
        Integer expireDays, 
        String password
    );
}
```

---

## 五、数据模型

### 5.1 前端数据模型

```javascript
// types/statistics.js

/**
 * 问卷整体统计
 */
const SurveyStatistics = {
  totalResponses: 0,        // 总填写数
  completedResponses: 0,    // 已完成数
  draftResponses: 0,        // 草稿数
  validRate: 0             // 有效率
}

/**
 * 选项统计
 */
const OptionStat = {
  optionValue: '',          // 选项值
  optionLabel: '',          // 选项标签
  count: 0,                 // 选择人数
  percentage: 0             // 比例
}

/**
 * 题目统计
 */
const QuestionStatistics = {
  formItemId: '',           // 表单项ID
  questionTitle: '',        // 题目标题
  questionType: '',         // 题目类型
  optionStats: [],          // 选项统计（选择题）
  totalCount: 0,            // 总人数
  validAnswers: 0,          // 有效答案数（文本题）
  totalAnswers: 0,          // 总答案数（文本题）
  wordCloudData: [],        // 词云数据（文本题）
  averageRating: 0,         // 平均分（评分题）
  maxRating: 0,             // 最高分
  minRating: 0,             // 最低分
  totalRatings: 0           // 评分人数
}

/**
 * 显示设置
 */
const DisplaySettings = {
  showTable: true,          // 显示表格
  showBar: true,            // 显示条形图
  showAverage: true,        // 显示平均分
  hideEmpty: false,         // 隐藏空选项
  hideSkip: true            // 隐藏跳过项
}

/**
 * 配色方案
 */
const ColorScheme = {
  id: '',
  name: '',
  colors: [],
  preview: ''
}

/**
 * 词云数据项
 */
const WordCloudItem = {
  name: '',                 // 词语
  value: 0                  // 频次
}
```

### 5.2 后端数据模型

```java
// 筛选条件
public class FilterCondition {
    private String formItemId;      // 表单项ID
    private String optionValue;     // 选项值
}

// 分享请求
public class ShareRequest {
    private Long surveyId;
    private Integer expireDays;     // 有效期（天）
    private String password;        // 密码（可选）
}

// 分享响应
public class ShareResponse {
    private String shareCode;       // 分享码
    private String shareUrl;        // 分享链接
    private LocalDateTime expireTime; // 过期时间
}
```

---

## 六、实现步骤

### 阶段一：基础功能（1-2周）

1. ✅ 统一接口已实现（`getAllStatistics`）
2. ✅ 统计视图页面已存在（即默认报告页面）
3. ⬜ 完善统计表格组件（带条形图）
4. ⬜ 实现图表类型切换（饼状、圆环、柱状、折线、条形、表格）
5. ⬜ 文本题词云图支持（可选）

### 阶段二：高级功能（2-3周）

5. ⬜ 实现分类统计功能
6. ⬜ 完善数据分析标签页（交叉分析/对比分析）
   - 重命名"数据分析"标签页
   - 完善交叉分析功能
   - 实现对比分析功能
7. ⬜ 实现配色方案
8. ⬜ 实现显示设置

### 阶段三：导出功能（1-2周）

9. ⬜ 实现 PDF 导出
10. ⬜ 实现 Excel 导出
11. ⬜ 实现分享链接
12. ⬜ 实现报告生成（后端）

### 阶段四：优化（1周）

13. ⬜ 性能优化
14. ⬜ UI/UX 优化
15. ⬜ 测试和修复

---

## 七、注意事项

1. **性能优化**
   - 大数据量时使用虚拟滚动
   - 图表懒加载
   - 合理使用缓存

2. **兼容性**
   - 确保 ECharts 在不同浏览器正常显示
   - PDF 导出需要考虑样式兼容性

3. **用户体验**
   - 加载状态提示
   - 错误处理
   - 操作反馈

4. **数据安全**
   - 分享链接需要权限控制
   - 敏感数据脱敏处理

---

## 八、参考资源

- [ECharts 官方文档](https://echarts.apache.org/zh/index.html)
- [ECharts 词云图插件](https://github.com/ecomfe/echarts-wordcloud)
- [Element Plus 组件文档](https://element-plus.org/zh-CN/)
- [vue-echarts 文档](https://github.com/ecomfe/vue-echarts)
- [jsPDF 文档](https://github.com/parallax/jsPDF)
- [html2canvas 文档](https://html2canvas.hertzen.com/)

---

## 十、重要说明

### 10.1 页面结构对应关系

- **统计视图** = 默认报告页面（已存在，需要完善）
- **数据分析** = 交叉/对比分析（需要重命名现有标签页并完善功能）

### 10.2 技术栈说明

- **前端语言**：JavaScript（不使用 TypeScript）
- **图表库**：ECharts（已集成）
- **词云图**：使用 `echarts-wordcloud` 插件

### 10.3 文本题词云图实现

对于填空题（文本题），可以考虑以下实现方案：

1. **后端处理**：统计文本答案中的高频词汇
2. **数据格式**：
   ```javascript
   wordCloudData: [
     { name: '关键词1', value: 15 },
     { name: '关键词2', value: 12 },
     // ...
   ]
   ```
3. **前端展示**：使用 ECharts 词云图组件渲染

### 10.4 标签页命名建议

- 将现有的"数据分析"标签页改为显示"数据分析"，但内容为交叉/对比分析功能
- 保持"统计视图"标签页名称不变（即默认报告）

---

## 九、后续扩展

1. **数据大屏**：提供数据大屏展示模式
2. **自定义报告模板**：允许用户自定义报告模板
3. **定时报告**：定时生成报告并发送邮件
4. **数据对比**：支持多个问卷的数据对比
5. **实时统计**：WebSocket 实时更新统计数据

---

文档版本：v1.0  
创建日期：2025-01-XX  
最后更新：2025-01-XX

