# 在线问卷调查与数据分析系统后端开发规范文档

## 一、项目概述

### 1.1 技术栈

#### 后端技术栈

- **框架**：Spring Boot 2.6.13
- **持久层**：MyBatis Plus 3.5.x
- **安全认证**：Spring Security + JWT
- **缓存**：Redis 6.0+ (Spring Boot Starter Data Redis)
- **数据库**：MySQL 8.0+
- **连接池**：Druid
- **接口文档**：Swagger / Knife4j
- **工具类库**：Lombok、Hutool、Apache Commons
- **数据处理**：Jackson、Apache POI、EasyExcel、iText / Flying Saucer
- **构建工具**：Maven 3.6+
- **JDK版本**：JDK 1.8
- **其他**：文件上传（本地存储）

### 1.2 项目架构要求

- 后端采用分层架构，严格遵循MVC模式
- 前后端分离，通过RESTful API进行交互
- 使用Swagger/Knife4j实现接口文档自动生成
- 使用JWT进行身份认证和授权
- 使用Redis进行缓存和会话管理
- 文件存储采用本地存储方式，存储在后端项目根目录下的upload文件夹

### 1.3 项目基础信息

- **项目包名**：`com.server.surveyanalystserver`
- **项目名称**：在线问卷调查与数据分析系统后端
- **数据库名称**：`survey_analyst`
- **服务端口**：8080
- **API文档路径**：`/doc.html`（Knife4j）或 `/swagger-ui.html`（Swagger）

## 二、项目包结构规范

### 2.1 基础包结构

```
com.server.surveyanalystserver
├── SurveyAnalystServerApplication.java  # 启动类
├── common                               # 公共模块
│   ├── Result.java                      # 统一响应结果封装
│   └── ResultCode.java                  # 响应码定义
├── config                               # 配置类
│   ├── SecurityConfig                   # Spring Security配置
│   ├── RedisConfig                      # Redis配置
│   ├── MybatisPlusConfig                # MyBatis Plus配置
│   ├── SwaggerConfig                    # Swagger配置
│   ├── JwtConfig                        # JWT配置
│   ├── JwtAuthenticationFilter          # JWT认证过滤器
│   ├── FileConfig                       # 文件上传配置
│   └── WebConfig                        # Web配置
├── entity                               # 实体类（Entity层）
│   ├── User.java                        # 用户实体
│   ├── Survey.java                      # 问卷实体
│   ├── Question.java                    # 题目实体
│   ├── Option.java                      # 选项实体
│   ├── LogicRule.java                   # 逻辑规则实体
│   ├── Response.java                    # 填写记录实体
│   ├── Answer.java                      # 填写答案实体
│   ├── Template.java                    # 模板实体
│   ├── File.java                        # 文件实体
│   └── dto/                             # DTO类（统一存放）
│       ├── UserQueryDTO.java           # 用户查询DTO
│       ├── SurveyQueryDTO.java         # 问卷查询DTO
│       ├── ResponseExportDTO.java      # 填写记录导出DTO
│       └── ...                         # 其他DTO
├── mapper                               # 数据访问层（Mapper层）
│   ├── user/                            # 用户相关Mapper
│   │   ├── UserMapper.java
│   │   └── ...
│   ├── admin/                           # 管理员相关Mapper
│   │   ├── AdminMapper.java
│   │   └── ...
│   ├── SurveyMapper.java                # 问卷Mapper
│   ├── QuestionMapper.java              # 题目Mapper
│   ├── ResponseMapper.java              # 填写记录Mapper
│   ├── TemplateMapper.java              # 模板Mapper
│   └── FileMapper.java                  # 文件Mapper
├── service                              # 业务逻辑层接口（Service层）
│   ├── user/                            # 用户相关Service接口
│   │   ├── UserService.java
│   │   └── ...
│   ├── admin/                           # 管理员相关Service接口
│   │   ├── AdminUserService.java
│   │   ├── AdminSurveyService.java
│   │   └── ...
│   ├── SurveyService.java               # 问卷Service接口
│   ├── QuestionService.java             # 题目Service接口
│   ├── ResponseService.java             # 填写记录Service接口
│   ├── StatisticsService.java           # 统计Service接口
│   ├── AnalysisService.java             # 分析Service接口
│   ├── TemplateService.java             # 模板Service接口
│   └── FileService.java                 # 文件Service接口
├── service.impl                         # 业务逻辑层实现（ServiceImpl层）
│   ├── user/                            # 用户相关Service实现
│   │   ├── UserServiceImpl.java
│   │   └── ...
│   ├── admin/                           # 管理员相关Service实现
│   │   ├── AdminUserServiceImpl.java
│   │   ├── AdminSurveyServiceImpl.java
│   │   └── ...
│   ├── SurveyServiceImpl.java           # 问卷Service实现
│   ├── QuestionServiceImpl.java         # 题目Service实现
│   ├── ResponseServiceImpl.java         # 填写记录Service实现
│   ├── StatisticsServiceImpl.java       # 统计Service实现
│   ├── AnalysisServiceImpl.java         # 分析Service实现
│   ├── TemplateServiceImpl.java         # 模板Service实现
│   └── FileServiceImpl.java             # 文件Service实现
└── controller                           # 控制器层（Controller层）
    ├── user/                            # 用户相关Controller
    │   ├── UserController.java
    │   ├── SurveyController.java
    │   ├── QuestionController.java
    │   ├── ResponseController.java
    │   ├── StatisticsController.java
    │   ├── AnalysisController.java
    │   ├── TemplateController.java
    │   └── FileController.java
    └── admin/                           # 管理员相关Controller
        ├── AdminUserController.java
        ├── AdminSurveyController.java
        ├── AdminDataController.java
        └── AdminSystemController.java
```

### 2.2 包结构设计原则

- **分层清晰**：Entity、Mapper、Service、Controller严格分离
- **实体统一**：所有实体类统一放在entity包下，所有DTO统一放在entity.dto包下
- **角色分离**：用户相关和管理员相关的代码用文件夹区分（mapper/user、mapper/admin等）
- **职责明确**：不同功能的控制器分开，便于管理和维护

## 三、Entity层（实体类）规范

### 3.1 实体类命名规范

- 实体类使用大驼峰命名，如：`User`、`Survey`、`Question`
- 实体类必须实现`Serializable`接口
- 实体类必须添加`@Data`注解（Lombok）
- 实体类必须添加`@TableName`注解指定表名

### 3.2 实体类字段规范

- 主键字段必须使用`@TableId`注解，类型为`IdType.AUTO`
- 字段必须使用`@TableField`注解指定数据库字段名
- 时间字段使用`LocalDateTime`类型，并添加`@JsonFormat`注解格式化
- 自动填充字段使用`@TableField(fill = FieldFill.INSERT_UPDATE)`注解
- 所有字段必须添加`@ApiModelProperty`注解用于API文档说明
- 字段命名使用小驼峰，数据库字段使用下划线命名
- **敏感字段保护**：密码等敏感字段必须使用`@JsonProperty(access = JsonProperty.Access.WRITE_ONLY)`注解

### 3.3 实体类示例规范

```java
package com.server.surveyanalystserver.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import com.fasterxml.jackson.annotation.JsonProperty;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 用户实体类
 */
@Data
@TableName("user")
@ApiModel(description = "用户实体")
public class User implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    @TableId(value = "user_id", type = IdType.AUTO)
    @ApiModelProperty(value = "用户ID")
    private Long userId;
    
    @TableField("username")
    @ApiModelProperty(value = "用户名", required = true)
    private String username;
    
    @TableField("password")
    @ApiModelProperty(value = "密码（BCrypt加密）", required = true, hidden = true)
    @JsonProperty(access = JsonProperty.Access.WRITE_ONLY)
    private String password;
    
    @TableField("create_time")
    @ApiModelProperty(value = "创建时间")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime createTime;
    
    @TableField(value = "update_time", fill = FieldFill.INSERT_UPDATE)
    @ApiModelProperty(value = "更新时间")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime updateTime;
    
    @TableField("delete_flag")
    @ApiModelProperty(value = "逻辑删除标志")
    private Integer deleteFlag;
}
```

### 3.4 导入规范

- **必须使用import导入**：所有类必须通过import语句导入，禁止在代码中使用完整类名
- **正确示例**：
  ```java
  import com.baomidou.mybatisplus.annotation.FieldFill;
  
  @TableField(value = "update_time", fill = FieldFill.INSERT_UPDATE)
  ```
- **错误示例**：
  ```java
  // 禁止使用完整类名
  @TableField(value = "update_time", fill = com.baomidou.mybatisplus.annotation.FieldFill.INSERT_UPDATE)
  ```

### 3.5 实体类字段类型规范

- **主键类型**：统一使用`Long`类型
- **时间类型**：统一使用`LocalDateTime`
- **布尔类型**：使用`Integer`类型（0/1），配合逻辑删除使用
- **数值类型**：根据业务需求选择`Integer`、`Long`、`BigDecimal`
- **字符串类型**：使用`String`，根据长度限制添加`@TableField`注解

### 3.6 DTO类规范

#### 3.6.1 DTO类位置规范

- **DTO类必须统一放在`entity.dto`包中**，如：`com.server.surveyanalystserver.entity.dto`
- **禁止**：将DTO类放在`controller`包或`controller`的子包下
- **禁止**：将DTO类放在`common.dto`包下（除非是跨模块的通用DTO）
- DTO类用于特殊情况下的数据传输，如：文件导入、复杂查询参数、特殊验证场景等
- DTO类命名格式：`功能描述 + DTO`，如：`SurveyQueryDTO`、`ResponseExportDTO`

#### 3.6.2 DTO类使用场景

- **文件导入/导出**：Excel导入导出、文件上传等场景
- **复杂查询参数**：多条件组合查询、统计查询等
- **特殊验证场景**：需要特殊字段组合或验证的场景
- **跨模块数据传输**：不同模块间需要传递的数据（此类DTO可放在`common.dto`包下）

#### 3.6.3 DTO类规范要求

- DTO类必须添加`@ApiModel`注解用于Swagger文档
- 所有字段必须添加`@ApiModelProperty`注解说明
- 使用Lombok的`@Data`注解简化getter/setter
- DTO类命名必须具有业务含义，清晰表达用途

## 四、Mapper层规范

### 4.1 Mapper接口规范

- Mapper接口必须继承`BaseMapper<T>`，T为对应的实体类
- Mapper接口命名格式：`实体类名 + Mapper`，如：`UserMapper`、`SurveyMapper`
- Mapper接口必须添加`@Mapper`注解或在启动类添加`@MapperScan`（本项目在`MybatisPlusConfig`中配置`@MapperScan("com.server.surveyanalystserver.mapper")`）
- **组织方式**：
  - 用户相关Mapper放在`mapper.user`包下，如：`UserMapper`
  - 管理员相关Mapper放在`mapper.admin`包下，如：`AdminUserMapper`
  - 其他业务Mapper直接放在`mapper`包下，如：`SurveyMapper`、`QuestionMapper`
- 自定义查询方法必须使用`@Select`、`@Update`、`@Insert`、`@Delete`注解
- 复杂查询建议使用XML映射文件，XML文件放在`src/main/resources/mapper`目录下

### 4.2 Mapper方法命名规范

- 查询方法：`select + 实体名 + By + 条件`，如：`selectUserById`
- 更新方法：`update + 实体名 + By + 条件`
- 删除方法：`delete + 实体名 + By + 条件`
- 插入方法：`insert + 实体名`

### 4.3 Mapper示例规范

```java
package com.server.surveyanalystserver.mapper.user;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.server.surveyanalystserver.entity.User;
import org.apache.ibatis.annotations.Mapper;

/**
 * 用户Mapper接口
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    /**
     * 根据用户名查询用户
     * @param username 用户名
     * @return 用户信息
     */
    User selectUserByUsername(String username);
}
```

### 4.4 MyBatis Plus逻辑删除配置

- **必须配置逻辑删除**：在`application-dev.yml`中必须配置MyBatis Plus的逻辑删除功能
- **配置项**：
  ```yaml
  mybatis-plus:
    global-config:
      db-config:
        logic-delete-field: delete_flag  # 逻辑删除字段
        logic-delete-value: 1            # 逻辑删除值（已删除）
        logic-not-delete-value: 0        # 逻辑未删除值（未删除）
  ```
- **自动过滤**：配置后，MyBatis Plus会自动在查询时过滤`delete_flag = 0`的数据
- **自动更新**：调用`removeById()`或`remove()`方法时，会自动将`delete_flag`更新为`1`，而不是物理删除

## 五、Service层规范

### 5.1 Service接口规范

- Service接口必须继承`IService<T>`，T为对应的实体类
- Service接口命名格式：`实体类名 + Service`，如：`UserService`、`SurveyService`
- Service接口方法必须添加JavaDoc注释，说明方法功能、参数、返回值
- Service接口方法命名使用动词开头，如：`select`、`add`、`update`、`delete`
- **组织方式**：
  - 用户相关Service接口放在`service.user`包下，如：`UserService`
  - 管理员相关Service接口放在`service.admin`包下，如：`AdminUserService`、`AdminSurveyService`
  - 其他业务Service接口直接放在`service`包下，如：`SurveyService`、`QuestionService`

### 5.2 Service实现类规范

- Service实现类必须继承`ServiceImpl<Mapper, Entity>`并实现对应的Service接口
- Service实现类必须添加`@Service`注解
- Service实现类必须注入对应的Mapper
- Service实现类方法必须添加`@Override`注解
- 业务逻辑复杂的方法必须添加详细注释
- **组织方式**：
  - 用户相关Service实现放在`service.impl.user`包下，如：`UserServiceImpl`
  - 管理员相关Service实现放在`service.impl.admin`包下，如：`AdminUserServiceImpl`、`AdminSurveyServiceImpl`
  - 其他业务Service实现直接放在`service.impl`包下，如：`SurveyServiceImpl`、`QuestionServiceImpl`

### 5.3 Service层职责划分

- **单一职责**：一个Service实现类只负责一个实体类的业务逻辑
- **不可跨模块**：不同业务模块的Service不能互相调用业务方法（可通过Mapper查询基础数据）
- **权限校验**：Service层方法内部必须进行权限校验和数据权限过滤
- **事务管理**：涉及数据修改的方法必须添加`@Transactional`注解

### 5.4 Service方法规范

- 查询方法：返回实体对象或实体列表
- 新增方法：返回操作结果或新增的实体对象
- 更新方法：返回操作结果或更新的实体对象
- 删除方法：返回操作结果（**必须使用MyBatis Plus逻辑删除功能**）
- 所有方法必须进行参数校验和异常处理

#### 5.4.1 方法参数规范

- **参数数量限制**：单个方法的参数数量不应超过5个
- **参数过多处理**：当参数超过5个时，必须使用DTO对象封装参数
- **分页查询优化**：分页查询方法如果查询条件超过3个，必须使用QueryDTO封装查询条件

#### 5.4.2 状态值参数规范

- **禁止硬编码**：方法参数中的状态值、类型值等必须使用枚举类型，禁止使用`Integer`类型
- **枚举优先**：所有状态值、类型值参数应使用对应的枚举类

### 5.5 Service代码质量规范

#### 5.5.1 控制流嵌套规范

- **嵌套层级限制**：方法中的 if/else 嵌套层级不应超过 3 层
- **提取方法**：当嵌套层级超过 3 层时，必须提取为私有方法
- **提前返回**：优先使用提前返回（Early Return）模式，减少嵌套

#### 5.5.2 方法长度规范

- **方法长度限制**：单个方法代码行数不应超过 80 行
- **职责单一**：方法应只做一件事，保持职责单一
- **提取方法**：当方法过长时，应提取为多个私有方法

### 5.6 Service实现类示例规范

```java
package com.server.surveyanalystserver.service.impl.user;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.server.surveyanalystserver.entity.User;
import com.server.surveyanalystserver.entity.dto.UserQueryDTO;
import com.server.surveyanalystserver.mapper.user.UserMapper;
import com.server.surveyanalystserver.service.user.UserService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * 用户Service实现类
 */
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
    
    @Override
    public Page<User> getUserPage(Page<User> page, UserQueryDTO queryDTO) {
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        // 构建查询条件
        if (queryDTO.getUsername() != null) {
            wrapper.like(User::getUsername, queryDTO.getUsername());
        }
        return this.page(page, wrapper);
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public User addUser(User user) {
        // 业务逻辑处理
        this.save(user);
        return user;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deleteUser(Long userId) {
        // 使用MyBatis Plus逻辑删除，自动更新delete_flag为1
        return this.removeById(userId);
    }
}
```

## 六、Controller层规范

### 6.1 Controller类规范

- Controller类必须添加`@RestController`注解
- Controller类必须添加`@RequestMapping`注解指定基础路径
- Controller类必须添加`@Api`注解（Swagger）用于API文档分组
- Controller类命名格式：`功能模块 + Controller`，如：`UserController`、`SurveyController`
- Controller必须注入对应的Service接口
- **组织方式**：
  - 用户相关Controller放在`controller.user`包下，如：`UserController`、`SurveyController`、`StatisticsController`等
  - 管理员相关Controller放在`controller.admin`包下，如：`AdminUserController`、`AdminSurveyController`、`AdminDataController`等
  - 其他业务Controller直接放在`controller`包下（如需要）

### 6.2 Controller方法规范

- 所有方法必须添加`@ApiOperation`注解（Swagger）说明接口功能
- 所有方法必须添加权限控制注解（如`@PreAuthorize`）进行权限控制
- 请求参数必须使用`@RequestBody`或`@RequestParam`注解，并添加`@ApiParam`注解（Swagger）说明参数
- 返回结果必须使用统一的`Result`封装
- 方法命名使用RESTful风格：`get`、`post`、`put`、`delete`
- **使用Entity实体**：Controller层直接使用Entity实体类作为请求和响应对象，不创建额外的DTO类（特殊情况除外）
- **DTO使用规范**：如需使用DTO，必须从`entity.dto`包导入，禁止在`controller`包下创建DTO类

### 6.3 Controller层职责（重要 - 必须严格遵守）

- **⚠️ 核心原则：Controller层禁止编写任何业务逻辑代码**
- **所有业务逻辑必须放在Service层实现**
- **Controller只负责**：
  1. 接收HTTP请求参数（参数校验由Service层或使用`@Valid`注解完成）
  2. 调用Service层方法（一个Controller方法通常只调用一个Service方法）
  3. 将Service层返回结果封装为`Result`对象返回
  4. 异常处理（通过全局异常处理器统一处理，Controller中不捕获业务异常）

- **严格禁止在Controller中编写以下代码**：
  - ❌ **业务判断逻辑**：if/else判断、switch判断、数据验证、业务计算等
  - ❌ **数据转换处理**：stream().map()、数据格式转换、类型转换等
  - ❌ **数据组装**：构建Map、List等复杂数据结构、数据合并等
  - ❌ **调用多个Service方法组合业务逻辑**：应将这些逻辑封装到Service层的一个方法中
  - ❌ **直接操作数据库**：调用Mapper接口、执行SQL查询等
  - ❌ **创建工具类实例**：new ObjectMapper()、new SimpleDateFormat()等（应在Service层或配置类中处理）
  - ❌ **循环处理数据**：forEach、for循环处理业务数据等
  - ❌ **权限判断逻辑**：复杂的权限判断应在Service层完成（Controller只使用`@PreAuthorize`注解）

- **正确示例**：
  ```java
  // ✅ 正确：Controller只负责接收参数、调用Service、返回结果
  @PostMapping("/item/batch")
  public Result<Void> batchSaveFormItems(@RequestBody BatchSaveFormItemsDTO dto) {
      formItemService.batchSaveFormItems(dto);
      return Result.success("保存成功");
  }
  ```

- **错误示例**：
  ```java
  // ❌ 错误：Controller中包含业务逻辑（数据转换、类型判断等）
  @PostMapping("/item/batch")
  public Result<Void> batchSaveFormItems(@RequestBody Map<String, Object> data) {
      List<FormItem> items = data.get("items").stream().map(itemData -> {
          FormItem item = new FormItem();
          // ... 大量业务逻辑代码
      }).collect(Collectors.toList());
      formItemService.batchSave(formKey, items);
      return Result.success("保存成功");
  }
  ```

### 6.4 Controller职责划分原则

- **严格分离**：不同业务模块必须使用不同的Controller
- **角色分离**：不同角色的操作必须使用不同的Controller（用户Controller和管理员Controller分离）
- **不可混用**：一个Controller不能同时处理多个角色的业务逻辑
- **权限隔离**：每个Controller方法必须明确权限要求

### 6.5 RESTful API设计规范

- **GET**：查询操作，如：`GET /api/user/{id}`
- **POST**：新增操作，如：`POST /api/user`
- **PUT**：更新操作，如：`PUT /api/user/{id}`
- **DELETE**：删除操作，如：`DELETE /api/user/{id}`
- **路径命名**：使用小写字母和下划线，如：`/api/user_info`

### 6.6 Controller方法示例规范

```java
package com.server.surveyanalystserver.controller.user;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.server.surveyanalystserver.common.Result;
import com.server.surveyanalystserver.entity.User;
import com.server.surveyanalystserver.entity.dto.UserQueryDTO;
import com.server.surveyanalystserver.service.user.UserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

/**
 * 用户管理控制器
 */
@RestController
@RequestMapping("/api/user")
@Api(tags = "用户管理")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @ApiOperation(value = "分页查询用户列表", notes = "根据条件分页查询用户列表")
    @PreAuthorize("hasAnyRole('ROLE_ADMIN')")
    @GetMapping("/page")
    public Result<Page<User>> getUserPage(
            @ApiParam(value = "分页参数") Page<User> page,
            @ApiParam(value = "查询条件") @RequestBody UserQueryDTO queryDTO) {
        Page<User> result = userService.getUserPage(page, queryDTO);
        return Result.success("查询成功", result);
    }
    
    @ApiOperation(value = "新增用户", notes = "新增用户信息")
    @PreAuthorize("hasAnyRole('ROLE_ADMIN')")
    @PostMapping
    public Result<User> addUser(@ApiParam(value = "用户信息") @RequestBody User user) {
        User result = userService.addUser(user);
        return Result.success("新增成功", result);
    }
}
```

## 七、代码注释规范

### 7.0 注释基本原则

- **禁止在代码和注释中引用第三方项目名称（如 tduck 等）**：所有代码和注释都应该是项目自身的实现，不应提及外部参考项目
- 注释应当清晰、简洁、准确，只描述当前代码的功能和实现逻辑
- 类注释只包含功能描述，不包含作者、日期、参考来源等信息

### 7.1 类注释规范

- 所有类必须添加类注释，说明类的功能和用途
- 类注释只包含类描述，不包含作者和日期信息
- **禁止在注释中使用HTML标签**
- 示例：
  ```java
  /**
   * 统一响应结果封装
   */
  public class Result<T> {
      // ...
  }
  ```

### 7.2 方法注释规范

- 所有public方法必须添加JavaDoc注释
- 方法注释包含：方法描述、参数说明、返回值说明、异常说明
- **禁止在注释中使用HTML标签**
- 示例：
  ```java
  /**
   * 分页查询用户列表
   * @param page 分页参数
   * @param queryDTO 查询条件
   * @return 用户分页列表
   */
  public Page<User> getUserPage(Page<User> page, UserQueryDTO queryDTO) {
      // ...
  }
  ```

### 7.3 字段注释规范

- 实体类字段必须添加`@ApiModelProperty`注解说明
- 复杂业务字段必须添加行内注释
- 示例：
  ```java
  @ApiModelProperty(value = "用户名", required = true)
  private String username;  // 用于登录的唯一标识
  ```

## 八、导入语句规范

### 8.1 导入规范要求

- **所有类必须通过import语句导入**：禁止在代码中使用完整类名
- **禁止使用通配符导入**：禁止使用`import xxx.*;`，必须使用显式导入
- **正确示例**：
  ```java
  import com.baomidou.mybatisplus.annotation.FieldFill;
  import com.baomidou.mybatisplus.annotation.TableField;
  
  @TableField(value = "update_time", fill = FieldFill.INSERT_UPDATE)
  ```
- **错误示例**：
  ```java
  // 禁止使用完整类名
  @TableField(value = "update_time", fill = com.baomidou.mybatisplus.annotation.FieldFill.INSERT_UPDATE)
  
  // 禁止使用通配符导入
  import com.baomidou.mybatisplus.annotation.*;
  ```

### 8.2 导入语句组织

- 导入语句按以下顺序组织：
  1. JDK标准库
  2. 第三方库
  3. 项目内部类
- 每组导入之间空一行
- 示例：
  ```java
  import java.io.Serializable;
  import java.time.LocalDateTime;
  
  import com.baomidou.mybatisplus.annotation.IdType;
  import com.baomidou.mybatisplus.annotation.TableId;
  
  import com.server.surveyanalystserver.common.Result;
  ```

## 九、配置文件规范

### 9.1 application.yml配置

- 主配置文件：`application.yml`
- 开发环境配置：`application-dev.yml`
- 配置项说明：
  - `server.port`: 服务端口（默认8080）
  - `spring.datasource`: 数据库连接配置（使用Druid连接池）
  - `spring.data.redis`: Redis连接配置
  - `mybatis-plus`: MyBatis Plus配置
  - `security.jwt`: JWT配置
  - `file`: 文件上传配置（本地存储路径）

### 9.2 数据库配置规范

- 使用Druid连接池
- 数据库连接URL格式：`jdbc:mysql://localhost:3306/survey_analyst?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true`
- 逻辑删除字段：`delete_flag`（0-未删除，1-已删除）

### 9.3 JWT配置规范

- JWT密钥：通过`security.jwt.secret`配置
- Token过期时间：通过`security.jwt.expiration`配置（默认7天）
- Token刷新时间：通过`security.jwt.refresh-expiration`配置（默认30天）
- Token前缀：`Bearer `
- Token请求头：`Authorization`

### 9.4 文件存储配置规范

- 文件存储路径：后端项目根目录下的`upload`文件夹
- 建议目录结构：
  ```
  survey-analyst-server/
  ├── upload/
  │   ├── images/        # 图片文件
  │   ├── documents/     # 文档文件
  │   └── temp/          # 临时文件
  ```
- 文件访问：通过后端接口提供，确保安全性

### 9.5 Swagger/Knife4j 接口文档配置规范

#### 9.5.1 配置说明

- **文档工具**：使用 Knife4j（基于 Swagger 3.0）生成接口文档
- **访问地址**：
  - Knife4j 文档：`http://localhost:8080/doc.html`
  - Swagger UI：`http://localhost:8080/swagger-ui.html`
- **配置位置**：
  - Swagger 配置类：`config/SwaggerConfig.java`
  - 配置文件：`application-dev.yml` 中的 `knife4j` 配置项

#### 9.5.2 配置要求

- Swagger 配置类必须添加 `@EnableOpenApi` 和 `@EnableKnife4j` 注解
- 必须配置扫描包路径：`com.server.surveyanalystserver.controller`
- 必须配置全局请求参数支持 JWT Token 认证
- WebConfig 必须配置 Swagger/Knife4j 静态资源映射
- SecurityConfig 必须放行 Swagger/Knife4j 相关路径

## 十、接口文档规范

### 10.1 接口文档工具

- **使用工具**：Knife4j（基于 Swagger 3.0/OpenAPI 3.0）
- **访问地址**：`http://localhost:8080/doc.html`
- **备用地址**：`http://localhost:8080/swagger-ui.html`

### 10.2 Entity 层 Swagger 注解规范

#### 10.2.1 实体类注解要求

- **必须添加 `@ApiModel` 注解**：所有实体类必须在类上添加 `@ApiModel(description = "描述")` 注解
- **必须添加 `@ApiModelProperty` 注解**：所有字段必须添加 `@ApiModelProperty` 注解用于API文档说明
- **注解位置**：
  - `@ApiModel` 注解在类上
  - `@ApiModelProperty` 注解在字段上

#### 10.2.2 @ApiModelProperty 注解规范

- **value 属性**：必须填写，描述字段的含义和用途
- **required 属性**：必填字段设置为 `true`，非必填字段设置为 `false` 或不设置
- **hidden 属性**：敏感字段（如密码）设置为 `true`，不在文档中显示
- **示例**：
  ```java
  @ApiModelProperty(value = "用户ID")
  private Long id;
  
  @ApiModelProperty(value = "用户名", required = true)
  private String username;
  
  @ApiModelProperty(value = "密码（BCrypt加密）", required = true, hidden = true)
  private String password;
  ```

#### 10.2.3 实体类完整示例

```java
package com.server.surveyanalystserver.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 用户实体类
 */
@Data
@TableName("user")
@ApiModel(description = "用户实体")
public class User implements Serializable {

    private static final long serialVersionUID = 1L;

    @TableId(value = "id", type = IdType.AUTO)
    @ApiModelProperty(value = "用户ID")
    private Long id;

    @TableField("username")
    @ApiModelProperty(value = "用户名", required = true)
    private String username;

    @TableField("password")
    @ApiModelProperty(value = "密码（BCrypt加密）", required = true, hidden = true)
    private String password;

    @TableField("create_time")
    @ApiModelProperty(value = "创建时间")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime createTime;
}
```

### 10.3 DTO 类 Swagger 注解规范

#### 10.3.1 DTO 类注解要求

- **必须添加 `@ApiModel` 注解**：所有 DTO 类必须在类上添加 `@ApiModel(description = "描述")` 注解
- **必须添加 `@ApiModelProperty` 注解**：所有字段必须添加 `@ApiModelProperty` 注解
- **规范要求**：与实体类注解规范一致

#### 10.3.2 DTO 类完整示例

```java
package com.server.surveyanalystserver.entity.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * 用户登录DTO
 */
@Data
@ApiModel(description = "用户登录DTO")
public class UserLoginDTO {

    @ApiModelProperty(value = "登录名（账号或邮箱）", required = true)
    private String loginName;

    @ApiModelProperty(value = "密码", required = true)
    private String password;
}
```

### 10.4 Controller 层 Swagger 注解规范

#### 10.4.1 Controller 类注解要求

- **必须添加 `@Api` 注解**：所有 Controller 类必须在类上添加 `@Api(tags = "标签名称")` 注解
- **标签命名规范**：
  - 用户相关接口：`"用户管理"`、`"问卷管理"`、`"数据统计"` 等
  - 管理员相关接口：`"管理员-用户管理"`、`"管理员-问卷管理"` 等

#### 10.4.2 Controller 方法注解要求

- **必须添加 `@ApiOperation` 注解**：所有 Controller 方法必须添加 `@ApiOperation` 注解
- **@ApiOperation 注解属性**：
  - `value`：接口功能简要说明（必填）
  - `notes`：接口详细说明（可选，建议填写）
- **请求参数注解**：
  - `@RequestBody` 参数：必须添加 `@ApiParam` 注解说明
  - `@RequestParam` 参数：必须添加 `@ApiParam` 注解说明
  - `@PathVariable` 参数：必须添加 `@ApiParam` 注解说明

#### 10.4.3 Controller 完整示例

```java
package com.server.surveyanalystserver.controller.user;

import com.server.surveyanalystserver.common.Result;
import com.server.surveyanalystserver.entity.User;
import com.server.surveyanalystserver.service.user.UserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

/**
 * 用户管理控制器
 */
@RestController
@RequestMapping("/api/user")
@Api(tags = "用户管理")
public class UserController {

    @Autowired
    private UserService userService;

    @ApiOperation(value = "获取当前用户信息", notes = "获取当前登录用户信息")
    @PreAuthorize("hasAnyRole('ROLE_USER', 'ROLE_ADMIN')")
    @GetMapping("/current")
    public Result<User> getCurrentUser() {
        User user = userService.getCurrentUser();
        return Result.success("获取成功", user);
    }

    @ApiOperation(value = "更新用户信息", notes = "更新当前用户信息")
    @PreAuthorize("hasAnyRole('ROLE_USER', 'ROLE_ADMIN')")
    @PutMapping("/info")
    public Result<User> updateUserInfo(
            @ApiParam(value = "用户信息", required = true) @RequestBody User user) {
        User updatedUser = userService.updateUserInfo(user);
        return Result.success("更新成功", updatedUser);
    }
}
```

### 10.5 接口文档访问与使用

#### 10.5.1 访问方式

1. **启动后端服务**：确保后端服务已启动（默认端口 8080）
2. **访问文档地址**：
   - 推荐：`http://localhost:8080/doc.html`（Knife4j，界面更友好）
   - 备用：`http://localhost:8080/swagger-ui.html`（原生 Swagger UI）

#### 10.5.2 接口测试认证

1. **登录获取 Token**：
   - 调用 `/api/auth/login` 接口进行登录
   - 从响应中获取 `token` 字段

2. **配置 Token**：
   - 在 Swagger UI 右上角点击「Authorize」按钮
   - 在弹出的对话框中输入 Token，格式：`Bearer {token}`
   - 点击「Authorize」确认

3. **测试接口**：
   - 配置 Token 后，所有需要认证的接口会自动携带 Token
   - 可以直接在文档页面测试接口功能

#### 10.5.3 文档功能说明

- **接口分组**：按 Controller 的 `@Api(tags)` 标签自动分组
- **参数说明**：自动展示请求参数、响应参数的详细说明
- **在线测试**：支持在文档页面直接测试接口
- **数据模型**：展示所有 Entity 和 DTO 的字段说明

### 10.6 接口文档规范检查清单

在提交代码前，必须检查以下内容：

- [ ] 所有 Entity 类是否添加了 `@ApiModel` 和 `@ApiModelProperty` 注解
- [ ] 所有 DTO 类是否添加了 `@ApiModel` 和 `@ApiModelProperty` 注解
- [ ] 所有 Controller 类是否添加了 `@Api` 注解
- [ ] 所有 Controller 方法是否添加了 `@ApiOperation` 注解
- [ ] 所有请求参数是否添加了 `@ApiParam` 注解（如适用）
- [ ] 敏感字段是否设置了 `hidden = true`
- [ ] 必填字段是否设置了 `required = true`
- [ ] 注解描述是否清晰、准确

## 十一、代码质量检查规范

### 10.1 方法长度检查

- 单个方法代码行数不应超过 80 行
- 超过限制时，必须提取为多个私有方法

### 10.2 嵌套层级检查

- 方法中的 if/else 嵌套层级不应超过 3 层
- 超过限制时，必须重构代码，使用提前返回或提取方法

### 10.3 参数数量检查

- 单个方法的参数数量不应超过 5 个
- 超过限制时，必须使用DTO对象封装参数

### 10.4 硬编码值检查

- 禁止使用硬编码的魔法数字、字符串等
- 状态值、类型值必须使用枚举类型
- 常量值必须定义在常量类中

### 10.5 未使用代码检查

- 删除所有未使用的导入语句
- 删除所有未使用的枚举类、工具类、常量等
- 使用IDE的自动清理功能

## 十二、安全规范

### 11.1 数据安全

- 敏感数据加密存储（密码使用BCrypt加密）
- SQL注入防护：使用参数化查询（MyBatis Plus自动处理）
- XSS防护：前后端数据校验和转义

### 11.2 接口安全

- 所有接口必须进行身份认证（除登录、注册接口）
- 敏感操作必须进行二次验证
- 接口请求频率限制，防止暴力攻击
- 使用JWT进行身份认证和授权

### 11.3 密码安全

- 密码必须使用BCrypt加密存储
- 密码字段使用`@JsonProperty(access = JsonProperty.Access.WRITE_ONLY)`注解，防止响应中泄露

### 11.4 文件安全

- 文件上传必须进行类型和大小校验
- 文件存储路径不能直接暴露，通过接口访问
- 文件访问必须进行权限校验

## 十三、核心业务逻辑规范

### 12.1 问卷逻辑校验规范

- **问卷逻辑校验**：在数据收集模块中实现题目逻辑验证、必填项校验、选项关联性检查
- **实现位置**：`Service`层的`ResponseService`中实现
- **校验时机**：提交问卷时进行完整校验，草稿保存时进行基础校验

### 12.2 数据清洗规范

- **数据清洗算法**：在数据统计模块中实现去除重复数据、异常数据过滤、缺失值处理
- **实现位置**：`Service`层的`StatisticsService`中实现
- **清洗时机**：统计数据计算前进行数据清洗

### 12.3 多维度统计算法规范

- **多维度统计**：按性别、年龄、地域等多维度进行数据统计
- **实现位置**：`Service`层的`AnalysisService`中实现
- **统计方式**：使用SQL聚合查询或Java代码实现多维度交叉统计

## 十四、总结

本规范文档涵盖了在线问卷调查与数据分析系统后端开发的核心规范，包括：

- 技术栈选择（Spring Boot 2.6.13、MyBatis Plus、Spring Security + JWT等）
- 项目包结构设计（com.server.surveyanalystserver）
- 各层代码规范（Entity、Mapper、Service、Controller）
- 代码注释规范（禁止HTML标签、作者、日期）
- 导入语句规范
- 代码质量规范（方法长度、嵌套层级等）
- 配置文件规范（数据库、Redis、JWT、文件存储、Swagger/Knife4j）
- 接口文档规范（Entity、DTO、Controller 的 Swagger 注解要求）
- 安全规范
- 核心业务逻辑规范（问卷逻辑校验、数据清洗、多维度统计）

开发团队应严格遵守本规范，确保代码质量和项目的可维护性。

