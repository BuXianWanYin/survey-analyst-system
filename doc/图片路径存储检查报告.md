# 图片路径存储检查报告

## 检查时间
2025-12-06

## 检查内容
检查在添加展示组件（图片展示、轮播展示等）时，存入数据库的数据是带服务器IP和端口的完整图片路径，还是只存储后端根目录的相对路径。

## 检查结果

### 问题发现

**问题：数据库中存储的是完整URL（包含IP和端口），而不是相对路径**

#### 问题分析

1. **后端上传文件逻辑**（`FileServiceImpl.uploadFile()`）
   - 上传成功后返回相对路径：`/upload/2025/12/06/xxx.jpg`
   - ✅ 正确：后端只返回相对路径

2. **前端上传成功处理**（`editor.vue`）
   - `handleCarouselOptionUpload()`: 将相对路径转换为完整URL
   - `handleImageOptionUpload()`: 将相对路径转换为完整URL
   - `handleImageUpload()`: 将相对路径转换为完整URL
   - 转换后的URL格式：`http://localhost:8080/upload/2025/12/06/xxx.jpg`
   - ⚠️ 问题：前端将完整URL存储到组件配置中

3. **保存表单逻辑**（`saveFormItems()`）
   - 直接使用 `JSON.stringify(item)` 序列化整个组件对象
   - ❌ **问题**：没有将完整URL转换回相对路径
   - 数据库中 `scheme` 字段存储的是包含完整URL的JSON字符串

#### 影响范围

以下组件类型受影响：
- **图片展示组件** (`image`): `config.imageUrl`, `config.previewList`
- **轮播展示组件** (`carousel`): `config.options[].url`
- **图片选择组件** (`imageSelect`): `config.options[].image`
- 其他可能包含图片URL的组件配置

#### 潜在问题

1. **服务器迁移问题**：如果服务器IP或端口改变，数据库中存储的完整URL会失效
2. **环境切换问题**：开发、测试、生产环境使用不同域名，完整URL无法跨环境使用
3. **数据冗余**：存储完整URL占用更多存储空间
4. **维护困难**：需要手动更新数据库中的URL才能切换环境

## 修复方案

### 修复内容

1. **导入 `getRelativeImageUrl` 工具函数**
   ```javascript
   import { getImageUrl, getRelativeImageUrl } from '@/utils/image'
   ```

2. **创建图片URL转换函数**
   - 递归处理对象中的所有图片URL字段
   - 将完整URL转换为相对路径
   - 支持常见字段：`imageUrl`, `url`, `image`, `src`, `previewList`
   - 支持数组和嵌套对象

3. **修改保存逻辑**
   - 在 `saveFormItems()` 中，保存前调用转换函数
   - 确保数据库中存储的是相对路径

### 修复后的数据流

```
上传文件 → 后端返回相对路径 (/upload/xxx.jpg)
  ↓
前端转换为完整URL (http://localhost:8080/upload/xxx.jpg) → 用于前端显示
  ↓
保存表单前 → 转换回相对路径 (/upload/xxx.jpg)
  ↓
数据库存储 → 相对路径 (/upload/xxx.jpg)
  ↓
读取数据时 → 前端转换为完整URL → 用于显示
```

## 修复文件

- `survey-analyst-web/src/views/survey/edit/editor.vue`
  - 添加 `getRelativeImageUrl` 导入
  - 添加 `convertImageUrlsToRelative()` 函数
  - 修改 `saveFormItems()` 函数，在保存前转换URL

## 验证建议

1. **测试图片上传**
   - 上传图片到图片展示组件
   - 上传图片到轮播组件
   - 上传图片到图片选择组件

2. **检查数据库存储**
   - 查看 `form_item` 表的 `scheme` 字段
   - 确认存储的是相对路径（如 `/upload/2025/12/06/xxx.jpg`）
   - 确认不是完整URL（如 `http://localhost:8080/upload/...`）

3. **测试数据读取**
   - 重新加载表单配置
   - 确认图片能正常显示
   - 确认前端正确将相对路径转换为完整URL

4. **测试环境切换**
   - 在不同环境（开发/测试/生产）中测试
   - 确认相对路径能正确适配不同环境的后端地址

## 总结

✅ **已修复**：现在数据库中存储的是相对路径，而不是完整URL。

**优势**：
- 数据更灵活，可跨环境使用
- 服务器迁移更方便
- 存储空间更小
- 维护成本更低

**注意事项**：
- 前端显示时需要将相对路径转换为完整URL（已有 `getImageUrl()` 函数处理）
- 确保所有图片URL字段都被正确处理

