# 题目表、选项表、答案表数据情况分析

## 一、数据检查结果

### 1.1 数据统计

通过 MCP 查询数据库，得到以下结果：

| 表名 | 数据量 | 状态 |
|------|--------|------|
| `question` (题目表) | 19条 | ⚠️ 有数据但关联问卷可能已删除 |
| `option` (选项表) | 0条 | ❌ 无数据 |
| `answer` (答案表) | 0条 | ❌ 无数据 |
| `survey` (问卷表) | 2条有效问卷 | ✅ 正常 |
| `response` (响应表) | 1条 | ✅ 正常 |
| `form_data` (表单数据表) | 1条 | ✅ 正常 |
| `form_item` (表单项表) | 19条 | ✅ 正常 |

### 1.2 详细数据情况

#### question 表
- **数据量**：19条
- **关联问卷**：所有题目都关联到 `survey_id = 1`
- **问题**：`survey_id = 1` 的问卷在数据库中不存在或已被删除（`delete_flag = 1`）
- **题目类型**：包括 SINGLE_CHOICE、MULTIPLE_CHOICE、TEXT、TEXTAREA、MATRIX、SORT 等

#### option 表
- **数据量**：0条
- **问题**：即使有选择题类型的题目，也没有对应的选项数据

#### answer 表
- **数据量**：0条
- **问题**：虽然有1条 `response` 记录（`survey_id = 2`），但没有对应的 `answer` 记录

---

## 二、表的作用说明

### 2.1 `question` 表 - 题目表

**作用**：存储问卷中的题目信息

**字段说明**：
- `id` - 题目主键ID
- `survey_id` - 问卷ID（关联survey表）
- `type` - 题型（SINGLE_CHOICE, MULTIPLE_CHOICE, TEXT, TEXTAREA, RATING, SORT, MATRIX, FILE, DATE）
- `title` - 题目标题
- `description` - 题目描述
- `required` - 是否必填（0-否，1-是）
- `order_num` - 排序号
- `create_time` - 创建时间
- `update_time` - 更新时间

**使用场景**：
- 传统问卷系统的题目存储
- 统计分析时查询题目信息

---

### 2.2 `option` 表 - 选项表

**作用**：存储选择题的选项信息

**字段说明**：
- `id` - 选项主键ID
- `question_id` - 题目ID（关联question表）
- `content` - 选项内容
- `image_url` - 选项图片URL（支持图片选项）
- `order_num` - 排序号
- `create_time` - 创建时间

**使用场景**：
- 传统问卷系统的选项存储
- 单选题、多选题的选项管理
- 统计分析时查询选项信息

---

### 2.3 `answer` 表 - 答案表

**作用**：存储具体的答案数据

**字段说明**：
- `id` - 答案主键ID
- `response_id` - 填写记录ID（关联response表）
- `question_id` - 题目ID（关联question表）
- `option_id` - 选项ID（选择题时使用）
- `content` - 答案内容（填空题时使用）
- `file_url` - 文件URL（文件上传题时使用）
- `create_time` - 创建时间

**使用场景**：
- 传统问卷系统的答案存储
- 支持选择题（通过option_id）、填空题（通过content）、文件上传题（通过file_url）
- 统计分析时查询答案数据

---

## 三、问题分析

### 3.1 系统使用了**两套数据存储方式**

#### 方式一：传统问卷系统（question/option/answer表）
- **设计目的**：传统的问卷系统架构
- **当前状态**：**基本未使用**
- **问题**：
  - `question` 表有数据，但关联的问卷可能已被删除
  - `option` 表是空的，选项信息未存储在此表
  - `answer` 表是空的，答案数据未存储在此表

#### 方式二：表单系统（form_config/form_item/form_data表）
- **设计目的**：基于表单构建器的问卷系统
- **当前状态**：**正在使用**
- **数据存储**：
  - 题目信息存储在 `form_item` 表中
  - 选项信息存储在 `form_item.scheme` 字段（JSON格式）
  - 答案数据存储在 `form_data.original_data` 字段（JSON格式）

### 3.2 具体问题分析

#### 问题1：question表数据孤立
- **现象**：`question` 表有19条数据，都关联到 `survey_id = 1`
- **原因**：`survey_id = 1` 的问卷可能已被逻辑删除（`delete_flag = 1`）或物理删除
- **影响**：这些题目数据成为孤立数据，无法正常使用

#### 问题2：option表为空
- **现象**：即使有选择题类型的题目，`option` 表也没有数据
- **原因**：系统使用 `form_item` 表存储表单项配置，选项信息存储在 `form_item.scheme` 字段的JSON中
- **示例**：
  ```json
  {
    "config": {
      "options": [
        {"label": "选项1", "value": "option1"},
        {"label": "选项2", "value": "option2"}
      ]
    }
  }
  ```
- **影响**：如果代码中有依赖 `option` 表的逻辑，可能会出现问题

#### 问题3：answer表为空
- **现象**：虽然有1条 `response` 记录，但 `answer` 表没有对应的答案数据
- **原因**：系统将答案数据存储在 `form_data.original_data` 字段（JSON格式）中
- **示例**：
  ```json
  {
    "radio-1765229664203": "option2",
    "checkbox-1765229647306": ["option2"],
    "input-1765228180612": "6346"
  }
  ```
- **影响**：如果代码中有依赖 `answer` 表的逻辑，可能会出现问题

---

## 四、代码实现分析

### 4.1 答案保存逻辑

在 `ResponseServiceImpl.saveAnswers()` 方法中，系统确实有保存到 `answer` 表的逻辑：

```java
private void saveAnswers(Long responseId, Map<Long, Object> answers) {
    for (Map.Entry<Long, Object> entry : answers.entrySet()) {
        Long questionId = entry.getKey();
        Object answerValue = entry.getValue();
        
        if (answerValue instanceof List) {
            // 多选题：保存多个选项
            List<Long> optionIds = (List<Long>) answerValue;
            for (Long optionId : optionIds) {
                Answer answer = new Answer();
                answer.setResponseId(responseId);
                answer.setQuestionId(questionId);
                answer.setOptionId(optionId);
                answerMapper.insert(answer);
            }
        } else if (answerValue instanceof Long) {
            // 单选题：保存单个选项
            Answer answer = new Answer();
            answer.setResponseId(responseId);
            answer.setQuestionId(questionId);
            answer.setOptionId((Long) answerValue);
            answerMapper.insert(answer);
        } else if (answerValue instanceof String) {
            // 填空题：保存文本内容
            Answer answer = new Answer();
            answer.setResponseId(responseId);
            answer.setQuestionId(questionId);
            answer.setContent((String) answerValue);
            answerMapper.insert(answer);
        }
    }
}
```

**问题**：这个方法期望接收 `Map<Long, Object>` 格式的数据，其中 key 是 `questionId`。但当前系统使用的是 `formItemId` 作为 key，而不是 `questionId`。

### 4.2 数据存储流程

当前系统的数据存储流程：

1. **问卷创建**：
   - 创建 `survey` 记录
   - 创建 `form_config` 记录（关联到survey）
   - 创建 `form_item` 记录（存储题目和选项配置，JSON格式）

2. **问卷填写**：
   - 创建 `response` 记录
   - 保存答案到 `form_data.original_data`（JSON格式，key为formItemId）
   - **理论上**应该同时保存到 `answer` 表，但实际没有保存

3. **数据查询**：
   - 从 `form_data` 表查询答案数据
   - 从 `form_item` 表查询题目和选项配置

---

## 五、解决方案建议

### 5.1 清理孤立数据

**建议**：清理 `question` 表中关联到已删除问卷的数据

```sql
-- 查看孤立数据
SELECT q.* FROM question q
LEFT JOIN survey s ON q.survey_id = s.id
WHERE s.id IS NULL OR s.delete_flag = 1;

-- 删除孤立数据（谨慎操作）
DELETE FROM question WHERE survey_id IN (
    SELECT id FROM survey WHERE delete_flag = 1
    OR id NOT IN (SELECT DISTINCT id FROM survey)
);
```

### 5.2 统一数据存储方式

**方案A：完全使用表单系统（推荐）**
- 优点：数据结构统一，维护简单
- 缺点：需要修改依赖 `question/option/answer` 表的代码
- 操作：
  1. 确认所有功能都使用 `form_item` 和 `form_data` 表
  2. 删除或注释掉 `saveAnswers()` 方法中保存到 `answer` 表的逻辑
  3. 修改统计分析等依赖 `answer` 表的代码，改为从 `form_data` 表查询

**方案B：双写机制**
- 优点：兼容两套系统
- 缺点：数据冗余，维护复杂
- 操作：
  1. 在保存答案时，同时保存到 `answer` 表和 `form_data` 表
  2. 需要建立 `formItemId` 到 `questionId` 的映射关系
  3. 需要建立选项的 `value` 到 `optionId` 的映射关系

### 5.3 数据迁移（如果需要）

如果需要将 `form_item` 和 `form_data` 的数据迁移到 `question/option/answer` 表：

1. **迁移题目**：从 `form_item` 表提取题目信息，保存到 `question` 表
2. **迁移选项**：从 `form_item.scheme` 字段提取选项信息，保存到 `option` 表
3. **迁移答案**：从 `form_data.original_data` 字段提取答案信息，保存到 `answer` 表

**注意**：需要建立正确的关联关系（formItemId -> questionId, optionValue -> optionId）

---

## 六、当前数据状态总结

### 6.1 实际使用的表

| 表名 | 用途 | 数据量 | 状态 |
|------|------|--------|------|
| `form_config` | 表单配置 | 有数据 | ✅ 正常使用 |
| `form_item` | 表单项（题目+选项） | 19条 | ✅ 正常使用 |
| `form_data` | 表单数据（答案） | 1条 | ✅ 正常使用 |
| `response` | 填写记录 | 1条 | ✅ 正常使用 |

### 6.2 未使用的表

| 表名 | 用途 | 数据量 | 状态 |
|------|------|--------|------|
| `question` | 题目表 | 19条（孤立数据） | ⚠️ 未使用 |
| `option` | 选项表 | 0条 | ❌ 未使用 |
| `answer` | 答案表 | 0条 | ❌ 未使用 |

---

## 七、结论

1. **系统当前主要使用表单系统**（`form_config/form_item/form_data`），而不是传统的问卷系统（`question/option/answer`）

2. **`question` 表有数据但孤立**：19条数据关联到已删除的问卷

3. **`option` 表为空**：选项信息存储在 `form_item.scheme` 字段的JSON中

4. **`answer` 表为空**：答案数据存储在 `form_data.original_data` 字段的JSON中

5. **建议**：
   - 如果确定不再使用传统问卷系统，可以清理 `question` 表中的孤立数据
   - 如果未来需要使用 `answer` 表进行统计分析，需要修改代码实现双写机制
   - 或者完全迁移到表单系统，删除对 `question/option/answer` 表的依赖

---

**检查时间**：2024年12月  
**检查方法**：MCP数据库查询 + 代码分析

