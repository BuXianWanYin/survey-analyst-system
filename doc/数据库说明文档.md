# 数据库说明文档

## 一、概述

本文档详细说明了 `survey_analyst` 数据库中的所有表结构、字段定义和注释信息。

**数据库名称：** survey_analyst  
**数据库类型：** MySQL  
**字符集：** UTF-8

## 二、表结构说明

### 2.1 用户相关表

#### `user` - 用户表

**表注释：** 用户表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 用户ID |
| account | varchar(50) | NO | UNI | null | | 账号（用于登录，唯一） |
| email | varchar(100) | NO | UNI | null | | 邮箱（用于登录，唯一） |
| username | varchar(50) | NO | | null | | 用户名（昵称，不用于登录，可重复） |
| phone | varchar(20) | YES | MUL | null | | 手机号 |
| password | varchar(255) | NO | | null | | 密码（BCrypt加密） |
| avatar | varchar(255) | YES | | null | | 头像URL |
| role | varchar(20) | YES | | USER | | 角色：USER, ADMIN |
| status | tinyint | YES | | 1 | | 状态：0-禁用，1-启用 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP | 更新时间 |
| delete_flag | tinyint | YES | | 0 | | 删除标志：0-未删除，1-已删除 |

**说明：**
- 主键：`id`
- 唯一索引：`account`、`email`
- 普通索引：`phone`
- 支持账号或邮箱登录
- 使用逻辑删除（`delete_flag`）

---

### 2.2 问卷相关表

#### `survey` - 问卷表

**表注释：** 问卷表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 问卷ID |
| user_id | bigint | NO | MUL | null | | 创建用户ID |
| title | varchar(200) | NO | | null | | 问卷标题 |
| description | text | YES | | null | | 问卷描述 |
| cover_img | varchar(500) | YES | | null | | 封面图URL |
| status | varchar(20) | YES | MUL | DRAFT | | 状态：DRAFT-草稿，PUBLISHED-已发布，ENDED-已结束 |
| access_type | varchar(20) | YES | | PUBLIC | | 访问类型：PUBLIC-公开，PASSWORD-密码访问 |
| password | varchar(100) | YES | | null | | 访问密码 |
| max_responses | int | YES | | null | | 最大填写数 |
| start_time | datetime | YES | | null | | 开始时间 |
| end_time | datetime | YES | | null | | 结束时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP | 更新时间 |
| delete_flag | tinyint | YES | | 0 | | 删除标志 |

**说明：**
- 主键：`id`
- 外键关联：`user_id` → `user.id`（逻辑外键）
- 普通索引：`user_id`、`status`
- 使用逻辑删除（`delete_flag`）

---

#### `response` - 填写记录表

**表注释：** 填写记录表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 填写记录ID |
| survey_id | bigint | NO | MUL | null | | 问卷ID |
| user_id | bigint | YES | MUL | null | | 填写用户ID（匿名填写为NULL） |
| ip_address | varchar(50) | YES | | null | | IP地址 |
| device_type | varchar(20) | YES | | null | | 设备类型：PC, MOBILE |
| start_time | datetime | YES | | null | | 开始填写时间 |
| submit_time | datetime | YES | | null | | 提交时间 |
| duration | int | YES | | null | | 填写时长（秒） |
| status | varchar(20) | YES | | COMPLETED | | 状态：COMPLETED-已完成，DRAFT-草稿 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 外键关联：`survey_id` → `survey.id`（逻辑外键）、`user_id` → `user.id`（逻辑外键）
- 普通索引：`survey_id`、`user_id`
- 支持匿名填写（`user_id` 可为 NULL）

---

### 2.3 表单相关表

#### `form_config` - 表单配置表

**表注释：** 表单配置表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| form_key | varchar(50) | NO | UNI | null | | 表单唯一标识 |
| survey_id | bigint | YES | MUL | null | | 关联的问卷ID |
| name | text | NO | | null | | 表单名称 |
| description | text | YES | | null | | 表单描述 |
| user_id | bigint | NO | | null | | 用户ID |
| type | varchar(10) | YES | | null | | 表单类型 |
| status | tinyint | NO | | 0 | | 状态 |
| is_deleted | tinyint(1) | NO | | 0 | | 是否删除 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 唯一索引：`form_key`
- 普通索引：`survey_id`
- 外键关联：`survey_id` → `survey.id`（逻辑外键）、`user_id` → `user.id`（逻辑外键）

---

#### `form_data` - 表单收集数据结果

**表注释：** 表单收集数据结果

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| form_key | varchar(100) | NO | MUL | null | | 表单key |
| serial_number | int | YES | | null | | 序号 |
| original_data | json | YES | | null | | 填写结果 |
| submit_browser | varchar(50) | YES | | null | | 提交浏览器 |
| submit_request_ip | varchar(50) | YES | | null | | 请求ip |
| start_time | datetime | YES | | null | | 开始填写时间 |
| complete_time | int | YES | | null | | 完成时间 秒 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |

**说明：**
- 主键：`id`
- 普通索引：`form_key`
- 外键关联：`form_key` → `form_config.form_key`（逻辑外键）
- `original_data` 字段存储 JSON 格式的填写结果

---

#### `form_item` - 表单项

**表注释：** 表单项

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| form_key | varchar(100) | NO | MUL | null | | 表单key |
| form_item_id | text | NO | | null | | 表单项Id |
| type | text | NO | | null | | 表单项类型 |
| label | text | NO | | null | | 表单项标题 |
| is_display_type | tinyint(1) | NO | | 0 | | 展示类型组件 |
| is_hide_type | tinyint(1) | NO | | 0 | | 隐藏类型组件 |
| is_special_type | tinyint(1) | NO | | 0 | | 特殊处理类型 |
| show_label | tinyint(1) | NO | | 0 | | 是否显示标签 |
| default_value | text | YES | | null | | 默认值 |
| required | tinyint(1) | NO | | null | | 是否必填 |
| placeholder | varchar(255) | YES | | null | | 输入型提示文字 |
| sort | bigint | YES | | 0 | | 排序 |
| span | int | NO | | 24 | | 栅格宽度 |
| scheme | json | YES | | null | | 表单项原始JSON |
| reg_list | json | YES | | null | | 正则表达式 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 普通索引：`form_key`
- 外键关联：`form_key` → `form_config.form_key`（逻辑外键）
- `scheme` 和 `reg_list` 字段存储 JSON 格式数据

---

#### `form_logic` - 表单逻辑表

**表注释：** 表单逻辑表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| survey_id | bigint | NO | UNI | null | | 问卷ID（逻辑外键） |
| scheme | json | YES | | null | | 逻辑定义（JSON格式） |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 唯一索引：`survey_id`
- 外键关联：`survey_id` → `survey.id`（逻辑外键）
- `scheme` 字段存储 JSON 格式的逻辑定义

---

#### `form_setting` - 表单设置表

**表注释：** 表单设置表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| survey_id | bigint | NO | UNI | null | | 问卷ID（逻辑外键） |
| settings | json | YES | | null | | 设置内容（JSON格式） |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 唯一索引：`survey_id`
- 外键关联：`survey_id` → `survey.id`（逻辑外键）
- `settings` 字段存储 JSON 格式的设置内容

---

#### `form_theme` - 表单主题表

**表注释：** 表单主题表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| survey_id | bigint | NO | UNI | null | | 问卷ID（逻辑外键） |
| submit_btn_text | varchar(20) | YES | | 提交 | | 提交按钮文字 |
| logo_img | varchar(255) | YES | | null | | logo图片 |
| logo_position | varchar(10) | YES | | left | | logo位置 |
| logo_size | int | YES | | 60 | | Logo大小（像素） |
| background_color | varchar(200) | YES | | null | | 背景颜色 |
| background_img | varchar(255) | YES | | null | | 背景图片 |
| show_title | tinyint(1) | YES | | 1 | | 是否显示标题 |
| show_describe | tinyint(1) | YES | | 1 | | 是否显示描述语 |
| theme_color | varchar(50) | YES | | null | | 主题颜色 |
| show_number | tinyint(1) | YES | | 0 | | 显示序号 |
| show_submit_btn | tinyint(1) | YES | | 1 | | 显示提交按钮 |
| head_img_url | varchar(255) | YES | | null | | 头部图片 |
| head_img_height | int | YES | | 150 | | 头图高度（像素） |
| btn_font_size | int | YES | | 15 | | 按钮字体大小（像素） |
| btn_width | int | YES | | 240 | | 按钮宽度（像素） |
| btn_height | int | YES | | 48 | | 按钮高度（像素） |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 更新时间 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 唯一索引：`survey_id`
- 外键关联：`survey_id` → `survey.id`（逻辑外键）
- 存储表单的视觉主题配置

---

#### `form_template` - 表单模板表

**表注释：** 表单模板表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| form_key | varchar(100) | NO | UNI | null | | 模板唯一标识 |
| name | varchar(200) | NO | | null | | 模板名称 |
| cover_img | varchar(500) | YES | | null | | 封面图 |
| description | text | YES | | null | | 模板描述 |
| category_id | bigint | NO | MUL | null | | 模板分类ID |
| status | bigint | YES | | 1 | | 状态：0-禁用，1-启用 |
| user_id | bigint | YES | MUL | null | | 创建用户ID |
| is_public | tinyint(1) | YES | | 0 | | 是否公共模板：0-我的模板，1-公共模板 |
| scheme | json | YES | | null | | 模板内容定义（JSON格式） |
| is_deleted | int | YES | MUL | 0 | | 删除标志：0-未删除，1-已删除 |
| create_time | datetime | YES | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP | 更新时间 |

**说明：**
- 主键：`id`
- 唯一索引：`form_key`
- 普通索引：`category_id`、`user_id`、`is_deleted`、`create_time`
- 外键关联：`category_id` → `form_template_category.id`（逻辑外键）、`user_id` → `user.id`（逻辑外键）
- `scheme` 字段存储 JSON 格式的模板内容定义

---

#### `form_template_category` - 表单模板分类表

**表注释：** 表单模板分类表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 主键ID |
| user_id | bigint | YES | | null | | 用户ID：NULL-系统分类，有值-用户自定义分类 |
| name | varchar(100) | NO | | null | | 分类名称 |
| sort | int | YES | MUL | 0 | | 排序号 |
| is_deleted | int | YES | MUL | 0 | | 删除标志：0-未删除，1-已删除 |
| create_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |
| update_time | datetime | YES | | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP | 更新时间 |

**说明：**
- 主键：`id`
- 普通索引：`sort`、`is_deleted`
- 外键关联：`user_id` → `user.id`（逻辑外键，可为 NULL 表示系统分类）

---

### 2.4 日志相关表

#### `operation_log` - 操作日志表

**表注释：** 操作日志表

| 字段名 | 类型 | 是否可空 | 键 | 默认值 | 额外信息 | 注释 |
|--------|------|----------|-----|--------|----------|------|
| id | bigint | NO | PRI | null | auto_increment | 日志ID |
| user_id | bigint | YES | MUL | null | | 操作用户ID |
| operation_type | varchar(50) | NO | MUL | null | | 操作类型 |
| operation_desc | varchar(500) | YES | | null | | 操作描述 |
| request_url | varchar(255) | YES | | null | | 请求URL |
| request_method | varchar(20) | YES | | null | | 请求方法 |
| request_params | text | YES | | null | | 请求参数 |
| response_result | text | YES | | null | | 响应结果 |
| ip_address | varchar(50) | YES | | null | | IP地址 |
| create_time | datetime | YES | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED | 创建时间 |

**说明：**
- 主键：`id`
- 普通索引：`user_id`、`operation_type`、`create_time`
- 外键关联：`user_id` → `user.id`（逻辑外键）
- 用于记录系统操作日志

---

## 三、表关系说明

### 3.1 核心关系图

```
user (用户表)
  ├── survey (问卷表) - user_id
  │   ├── form_config (表单配置表) - survey_id
  │   │   ├── form_data (表单数据表) - form_key
  │   │   └── form_item (表单项表) - form_key
  │   ├── form_logic (表单逻辑表) - survey_id
  │   ├── form_setting (表单设置表) - survey_id
  │   └── form_theme (表单主题表) - survey_id
  ├── response (填写记录表) - user_id, survey_id
  ├── form_template (表单模板表) - user_id
  └── operation_log (操作日志表) - user_id

form_template_category (模板分类表)
  └── form_template (表单模板表) - category_id
```

### 3.2 外键关系说明

**注意：** 本数据库使用逻辑外键，未定义物理外键约束。以下为逻辑外键关系：

1. **survey.user_id** → **user.id**
2. **response.survey_id** → **survey.id**
3. **response.user_id** → **user.id**（可为 NULL，表示匿名填写）
4. **form_config.survey_id** → **survey.id**
5. **form_config.user_id** → **user.id**
6. **form_data.form_key** → **form_config.form_key**
7. **form_item.form_key** → **form_config.form_key**
8. **form_logic.survey_id** → **survey.id**
9. **form_setting.survey_id** → **survey.id**
10. **form_theme.survey_id** → **survey.id**
11. **form_template.category_id** → **form_template_category.id**
12. **form_template.user_id** → **user.id**
13. **form_template_category.user_id** → **user.id**（可为 NULL，表示系统分类）
14. **operation_log.user_id** → **user.id**

---

## 四、字段类型说明

### 4.1 常用数据类型

- **bigint**：大整数，用于主键和ID字段
- **varchar(n)**：可变长度字符串，n 为最大长度
- **text**：长文本
- **json**：JSON 格式数据
- **datetime**：日期时间
- **tinyint**：小整数（-128 到 127）
- **tinyint(1)**：布尔类型（0 或 1）
- **int**：整数

### 4.2 特殊字段说明

#### JSON 字段
以下字段存储 JSON 格式数据：
- `form_data.original_data`：填写结果
- `form_item.scheme`：表单项原始JSON
- `form_item.reg_list`：正则表达式
- `form_logic.scheme`：逻辑定义
- `form_setting.settings`：设置内容
- `form_template.scheme`：模板内容定义

#### 时间字段
- `create_time`：创建时间，默认值为 `CURRENT_TIMESTAMP`
- `update_time`：更新时间，默认值为 `CURRENT_TIMESTAMP`，并自动更新

#### 删除标志
- `delete_flag`：删除标志，0-未删除，1-已删除
- `is_deleted`：是否删除，0-未删除，1-已删除

---

## 五、索引说明

### 5.1 主键索引（PRI）
所有表都有 `id` 字段作为主键，类型为 `bigint`，自增。

### 5.2 唯一索引（UNI）
- `user.account`：账号唯一
- `user.email`：邮箱唯一
- `form_config.form_key`：表单唯一标识
- `form_logic.survey_id`：每个问卷只有一个逻辑配置
- `form_setting.survey_id`：每个问卷只有一个设置
- `form_theme.survey_id`：每个问卷只有一个主题
- `form_template.form_key`：模板唯一标识

### 5.3 普通索引（MUL）
- `user.phone`：手机号索引
- `survey.user_id`：用户ID索引
- `survey.status`：状态索引
- `response.survey_id`：问卷ID索引
- `response.user_id`：用户ID索引
- `form_config.survey_id`：问卷ID索引
- `form_data.form_key`：表单key索引
- `form_item.form_key`：表单key索引
- `form_template.category_id`：分类ID索引
- `form_template.user_id`：用户ID索引
- `form_template.is_deleted`：删除标志索引
- `form_template.create_time`：创建时间索引
- `form_template_category.sort`：排序号索引
- `form_template_category.is_deleted`：删除标志索引
- `operation_log.user_id`：用户ID索引
- `operation_log.operation_type`：操作类型索引
- `operation_log.create_time`：创建时间索引

---

## 六、数据字典

### 6.1 用户角色（user.role）
- `USER`：普通用户
- `ADMIN`：管理员

### 6.2 用户状态（user.status）
- `0`：禁用
- `1`：启用

### 6.3 问卷状态（survey.status）
- `DRAFT`：草稿
- `PUBLISHED`：已发布
- `ENDED`：已结束

### 6.4 访问类型（survey.access_type）
- `PUBLIC`：公开
- `PASSWORD`：密码访问

### 6.5 填写记录状态（response.status）
- `COMPLETED`：已完成
- `DRAFT`：草稿

### 6.6 设备类型（response.device_type）
- `PC`：电脑
- `MOBILE`：手机

### 6.7 模板状态（form_template.status）
- `0`：禁用
- `1`：启用

### 6.8 模板类型（form_template.is_public）
- `0`：我的模板
- `1`：公共模板

---

## 七、注意事项

### 7.1 逻辑删除
系统使用逻辑删除机制，删除操作实际上是更新 `delete_flag` 或 `is_deleted` 字段为 1，而不是物理删除数据。查询时需要注意过滤已删除的数据。

### 7.2 密码加密
用户密码使用 BCrypt 加密存储，不能直接插入明文密码。

### 7.3 JSON 字段
部分表包含 JSON 格式的字段，这些字段在查询和更新时需要特殊处理。

### 7.4 逻辑外键
虽然数据库表之间存在逻辑外键关系，但 MySQL 中可能没有定义物理外键约束。操作时需要注意维护数据一致性。

### 7.5 时间字段
时间字段使用 `datetime` 类型，格式为 `yyyy-MM-dd HH:mm:ss`。插入和更新时需要注意时间格式。

---

## 八、表统计

| 分类 | 表名 | 说明 |
|------|------|------|
| 用户相关 | user | 用户表 |
| 问卷相关 | survey | 问卷表 |
| 问卷相关 | response | 填写记录表 |
| 表单相关 | form_config | 表单配置表 |
| 表单相关 | form_data | 表单收集数据结果 |
| 表单相关 | form_item | 表单项 |
| 表单相关 | form_logic | 表单逻辑表 |
| 表单相关 | form_setting | 表单设置表 |
| 表单相关 | form_theme | 表单主题表 |
| 表单相关 | form_template | 表单模板表 |
| 表单相关 | form_template_category | 表单模板分类表 |
| 日志相关 | operation_log | 操作日志表 |

**总计：** 12 张表


