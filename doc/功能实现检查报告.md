# 问卷系统功能实现检查报告

## 检查日期
2024年

## 检查范围
对问卷系统的以下功能进行前后端代码和数据库检查：
1. 提交设置的提交后显示方式
2. 提交设置的提交后跳转网页地址
3. 通知设置的发邮件提醒
4. 分享设置
5. 发布的回收限制（最大填写数）
6. 每个IP答题次数限制
7. 每个设备答题次数限制
8. 每个用户答题次数限制
9. 访问的开始时间
10. 访问的结束时间

---

## 一、提交设置

### 1.1 提交后显示方式

**前端实现状态：✅ 已实现**

**位置：** `survey-analyst-web/src/views/survey/edit/setting/SubmitSetting.vue`

**实现情况：**
- 前端提供了设置界面，支持两种显示方式：
  - 系统默认提示（submitShowType = 1）
  - 自定义文案（submitShowType = 2）
- 当选择自定义文案时，可以输入自定义提示内容（submitShowCustomPageContent）
- 设置可以保存到数据库（通过 formApi.saveFormSetting）

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`submitShowType`、`submitShowCustomPageContent`

**后端实现状态：❌ 未实现**

**问题：**
- 后端提交接口（`ResponseServiceImpl.submitResponse`）未返回提交设置信息
- 前端提交成功后（`survey-analyst-web/src/views/survey/fill/index.vue`）未根据设置显示自定义提示
- 当前提交成功后固定显示"提交成功，感谢您的参与！"，未读取设置

**建议：**
- 后端提交接口需要返回提交设置信息
- 前端提交成功后需要根据 `submitShowType` 显示对应的提示内容

---

### 1.2 提交后跳转网页地址

**前端实现状态：✅ 已实现（设置界面）❌ 未实现（实际跳转）**

**位置：** 
- 设置界面：`survey-analyst-web/src/views/survey/edit/setting/SubmitSetting.vue`
- 提交处理：`survey-analyst-web/src/views/survey/fill/index.vue`

**实现情况：**
- 前端提供了设置界面，支持开启/关闭跳转功能
- 可以设置跳转URL（submitJumpUrl）
- 设置可以保存到数据库

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`submitJump`（布尔值）、`submitJumpUrl`（字符串）

**后端实现状态：❌ 未实现**

**问题：**
- 后端提交接口未返回跳转设置信息
- 前端提交成功后未根据 `submitJump` 和 `submitJumpUrl` 进行跳转
- 当前提交成功后固定跳转到 `/home`，未读取设置

**建议：**
- 后端提交接口需要返回跳转设置信息
- 前端提交成功后需要检查 `submitJump`，如果为 true 则跳转到 `submitJumpUrl`

---

## 二、通知设置

### 2.1 发邮件提醒

**前端实现状态：✅ 已实现**

**位置：** `survey-analyst-web/src/views/survey/edit/setting/NotifySetting.vue`

**实现情况：**
- 前端提供了邮件设置界面
- 支持添加多个邮箱（用分号分隔）
- 邮箱列表可以保存和删除
- 设置保存到数据库（emailNotify、newWriteNotifyEmail）

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`emailNotify`（布尔值）、`newWriteNotifyEmail`（字符串，多个邮箱用分号分隔）

**后端实现状态：✅ 已实现**

**位置：** 
- `survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/ResponseServiceImpl.java` (第129-153行)
- `survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/EmailServiceImpl.java`

**实现情况：**
- 后端在提交成功后检查邮件通知设置
- 如果启用了邮件通知（emailNotify = true）且有邮箱列表，会调用邮件服务发送通知
- 邮件服务已实现，支持发送到多个邮箱（分号分隔）

**邮件服务配置：**
- 需要配置 `spring.mail.*` 相关属性
- 邮件发送失败不影响主流程，只记录日志

**状态：✅ 功能完整实现**

---

## 三、分享设置

**前端实现状态：✅ 已实现**

**位置：** `survey-analyst-web/src/views/survey/edit/setting/ShareSetting.vue`

**实现情况：**
- 支持自定义分享图标（shareWxImg、shareWxImgUrl）
- 支持自定义分享标题（shareWxTitle、shareWxTitleContent）
- 支持自定义分享描述（shareWxDesc、shareWxDescContent）
- 提供预览功能
- 设置可以保存到数据库

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`shareWxImg`、`shareWxImgUrl`、`shareWxTitle`、`shareWxTitleContent`、`shareWxDesc`、`shareWxDescContent`

**后端实现状态：⚠️ 部分实现**

**问题：**
- 后端未提供获取分享设置的专门接口（可通过 getFormSetting 获取）
- 前端分享功能可能需要读取这些设置，但未检查是否已使用

**状态：✅ 设置功能完整，使用情况需确认**

---

## 四、发布设置

### 4.1 最大填写数

**前端实现状态：✅ 已实现**

**位置：** 
- `survey-analyst-web/src/views/survey/publish/index.vue`
- `survey-analyst-web/src/views/survey/edit/publish.vue`

**实现情况：**
- 前端提供了设置界面
- 支持设置最大填写数（maxResponses），0表示不限制
- 设置保存到 `survey` 表的 `max_responses` 字段

**数据库存储：**
- 存储在 `survey` 表的 `max_responses` 字段（INT类型）

**后端实现状态：✅ 已实现**

**位置：** `survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/ResponseServiceImpl.java` (第80-86行)

**实现情况：**
- 后端在提交时检查最大填写数限制
- 如果当前填写数 >= 最大填写数，会抛出异常阻止提交
- 前端在提交前也会进行预检查（`survey-analyst-web/src/views/survey/fill/index.vue` 第691-709行）

**状态：✅ 功能完整实现**

---

### 4.2 访问开始时间

**前端实现状态：✅ 已实现**

**位置：** 
- `survey-analyst-web/src/views/survey/publish/index.vue`
- `survey-analyst-web/src/views/survey/edit/publish.vue`

**实现情况：**
- 前端提供了日期时间选择器
- 支持设置开始时间（startTime）
- 设置保存到 `survey` 表的 `start_time` 字段

**数据库存储：**
- 存储在 `survey` 表的 `start_time` 字段（DATETIME类型）

**后端实现状态：✅ 已实现**

**位置：** `survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/ResponseServiceImpl.java` (第72-75行)

**实现情况：**
- 后端在提交时检查开始时间限制
- 如果当前时间 < 开始时间，会抛出异常阻止提交

**状态：✅ 功能完整实现**

---

### 4.3 访问结束时间

**前端实现状态：✅ 已实现**

**位置：** 
- `survey-analyst-web/src/views/survey/publish/index.vue`
- `survey-analyst-web/src/views/survey/edit/publish.vue`

**实现情况：**
- 前端提供了日期时间选择器
- 支持设置结束时间（endTime）
- 设置保存到 `survey` 表的 `end_time` 字段

**数据库存储：**
- 存储在 `survey` 表的 `end_time` 字段（DATETIME类型）

**后端实现状态：✅ 已实现**

**位置：** `survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/ResponseServiceImpl.java` (第76-78行)

**实现情况：**
- 后端在提交时检查结束时间限制
- 如果当前时间 > 结束时间，会抛出异常阻止提交

**状态：✅ 功能完整实现**

---

## 五、回收限制

### 5.1 每个IP答题次数限制

**前端实现状态：✅ 已实现（设置界面）**

**位置：** 
- `survey-analyst-web/src/views/survey/edit/publish.vue` (第71-83行)
- `survey-analyst-web/src/views/survey/edit/setting/WriteSetting.vue` (第9-11行，仅开关)

**实现情况：**
- 前端提供了设置界面
- 支持开启/关闭IP限制（ipWriteCountLimitStatus）
- 可以设置限制次数（ipWriteCountLimit）
- 设置保存到 `form_setting` 表的 `settings` 字段

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`ipWriteCountLimitStatus`（布尔值）、`ipWriteCountLimit`（整数）

**后端实现状态：❌ 未实现**

**问题：**
- 后端提交接口（`ResponseServiceImpl.submitResponse`）未检查IP限制
- 后端提交接口（`FormDataServiceImpl.saveFormData`）也未检查IP限制
- 虽然 `Response` 表有 `ip_address` 字段，`FormData` 表有 `submit_request_ip` 字段，但未用于限制验证

**建议：**
- 需要在提交时获取客户端IP地址
- 需要查询该IP地址的提交次数
- 如果超过限制，需要阻止提交并返回错误信息

**状态：❌ 设置功能完整，但验证逻辑缺失**

---

### 5.2 每个设备答题次数限制

**前端实现状态：✅ 已实现（设置界面）**

**位置：** `survey-analyst-web/src/views/survey/edit/publish.vue` (第85-97行)

**实现情况：**
- 前端提供了设置界面
- 支持开启/关闭设备限制（deviceWriteCountLimitStatus）
- 可以设置限制次数（deviceWriteCountLimit）
- 设置保存到 `form_setting` 表的 `settings` 字段

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`deviceWriteCountLimitStatus`（布尔值）、`deviceWriteCountLimit`（整数）

**后端实现状态：❌ 未实现**

**问题：**
- 后端提交接口未检查设备限制
- 虽然 `Response` 表有 `device_type` 字段，但设备标识需要更精确（如设备指纹）
- 当前没有设备唯一标识的获取和存储机制

**建议：**
- 需要实现设备唯一标识的获取（可通过浏览器指纹、localStorage等）
- 需要在提交时记录设备标识
- 需要查询该设备的提交次数
- 如果超过限制，需要阻止提交

**状态：❌ 设置功能完整，但验证逻辑缺失**

---

### 5.3 每个用户答题次数限制

**前端实现状态：✅ 已实现（设置界面）**

**位置：** `survey-analyst-web/src/views/survey/edit/publish.vue` (第99-111行)

**实现情况：**
- 前端提供了设置界面
- 支持开启/关闭用户限制（accountWriteCountLimitStatus）
- 可以设置限制次数（accountWriteCountLimit）
- 设置保存到 `form_setting` 表的 `settings` 字段

**数据库存储：**
- 存储在 `form_setting` 表的 `settings` 字段（JSON格式）
- 字段名：`accountWriteCountLimitStatus`（布尔值）、`accountWriteCountLimit`（整数）

**后端实现状态：❌ 未实现**

**问题：**
- 后端提交接口未检查用户限制
- 虽然 `Response` 表有 `user_id` 字段，但匿名填写时该字段为NULL
- 当前系统支持匿名填写，用户限制仅适用于已登录用户

**建议：**
- 对于已登录用户，需要检查 `user_id` 的提交次数
- 对于匿名用户，可以考虑使用其他标识（如cookie、session等）
- 需要在提交时记录用户标识
- 需要查询该用户的提交次数
- 如果超过限制，需要阻止提交

**状态：❌ 设置功能完整，但验证逻辑缺失**

---

## 六、数据库表结构检查

### 6.1 form_setting 表

**表结构：**
- `id` - 主键
- `survey_id` - 问卷ID
- `settings` - 设置内容（JSON格式）
- `update_time` - 更新时间
- `create_time` - 创建时间

**存储的设置项：**
- 提交设置：submitShowType, submitShowCustomPageContent, submitJump, submitJumpUrl
- 通知设置：emailNotify, newWriteNotifyEmail
- 分享设置：shareWxImg, shareWxImgUrl, shareWxTitle, shareWxTitleContent, shareWxDesc, shareWxDescContent
- 回收限制：ipWriteCountLimitStatus, ipWriteCountLimit, deviceWriteCountLimitStatus, deviceWriteCountLimit, accountWriteCountLimitStatus, accountWriteCountLimit

**状态：✅ 表结构完整**

---

### 6.2 survey 表

**相关字段：**
- `max_responses` - 最大填写数（INT）
- `start_time` - 开始时间（DATETIME）
- `end_time` - 结束时间（DATETIME）

**状态：✅ 字段完整**

---

### 6.3 response 表

**相关字段：**
- `ip_address` - IP地址（VARCHAR(50)）
- `device_type` - 设备类型（VARCHAR(20)）
- `user_id` - 用户ID（BIGINT，可为NULL）

**状态：✅ 字段完整，可用于限制验证**

---

### 6.4 form_data 表

**相关字段：**
- `submit_request_ip` - 请求IP（VARCHAR）
- `submit_ua` - 提交UA（JSON格式）

**状态：✅ 字段完整，可用于限制验证**

---

## 七、总结

### 7.1 已完整实现的功能

1. ✅ **最大填写数** - 前后端完整实现
2. ✅ **访问开始时间** - 前后端完整实现
3. ✅ **访问结束时间** - 前后端完整实现
4. ✅ **发邮件提醒** - 前后端完整实现
5. ✅ **分享设置** - 前端设置功能完整

### 7.2 部分实现的功能

1. ⚠️ **提交后显示方式** - 前端设置完整，但提交后未使用
2. ⚠️ **提交后跳转网页地址** - 前端设置完整，但提交后未使用
3. ⚠️ **每个IP答题次数限制** - 前端设置完整，后端验证缺失
4. ⚠️ **每个设备答题次数限制** - 前端设置完整，后端验证缺失
5. ⚠️ **每个用户答题次数限制** - 前端设置完整，后端验证缺失

### 7.3 需要修复的问题

#### 问题1：提交后显示方式和跳转未实现
**影响：** 用户设置的提交后显示方式和跳转地址无效

**修复方案：**
1. 后端提交接口返回提交设置信息
2. 前端提交成功后读取设置，根据 `submitShowType` 显示对应提示
3. 前端提交成功后检查 `submitJump`，如果为 true 则跳转到 `submitJumpUrl`

#### 问题2：IP答题次数限制未实现
**影响：** 无法防止同一IP重复提交

**修复方案：**
1. 在提交接口中获取客户端IP地址
2. 查询该IP地址在指定问卷下的提交次数
3. 如果超过限制，返回错误信息
4. 需要支持时间范围限制（如每天、每周等）

#### 问题3：设备答题次数限制未实现
**影响：** 无法防止同一设备重复提交

**修复方案：**
1. 实现设备唯一标识获取（浏览器指纹或localStorage）
2. 在提交时记录设备标识
3. 查询该设备的提交次数
4. 如果超过限制，返回错误信息

#### 问题4：用户答题次数限制未实现
**影响：** 无法防止同一用户重复提交

**修复方案：**
1. 对于已登录用户，使用 `user_id` 进行限制
2. 对于匿名用户，考虑使用cookie或session标识
3. 查询该用户的提交次数
4. 如果超过限制，返回错误信息

---

## 八、修复优先级建议

### 高优先级
1. **提交后显示方式和跳转** - 直接影响用户体验
2. **IP答题次数限制** - 防止刷票，重要安全功能

### 中优先级
3. **用户答题次数限制** - 防止重复提交
4. **设备答题次数限制** - 需要设备标识机制

---

## 九、代码位置参考

### 前端关键文件
- 提交设置：`survey-analyst-web/src/views/survey/edit/setting/SubmitSetting.vue`
- 通知设置：`survey-analyst-web/src/views/survey/edit/setting/NotifySetting.vue`
- 分享设置：`survey-analyst-web/src/views/survey/edit/setting/ShareSetting.vue`
- 发布设置：`survey-analyst-web/src/views/survey/edit/publish.vue`
- 填写页面：`survey-analyst-web/src/views/survey/fill/index.vue`

### 后端关键文件
- 提交服务：`survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/ResponseServiceImpl.java`
- 表单数据服务：`survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/FormDataServiceImpl.java`
- 邮件服务：`survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/EmailServiceImpl.java`
- 表单设置服务：`survey-analyst-server/src/main/java/com/server/surveyanalystserver/service/impl/FormSettingServiceImpl.java`

---

**报告生成时间：** 2024年
**检查人员：** AI Assistant

