# 数据库操作文档

## 表结构更新

### form_item 表

需要在 `form_item` 表中添加 `question_id` 字段，用于建立与 `question` 表的映射关系。

#### SQL 语句

```sql
-- 添加 question_id 字段（逻辑外键）
ALTER TABLE `form_item` 
ADD COLUMN `question_id` BIGINT NULL COMMENT '题目ID（逻辑外键，关联question表）' AFTER `form_item_id`;

-- 创建索引以提高查询性能
CREATE INDEX `idx_question_id` ON `form_item` (`question_id`);
CREATE INDEX `idx_form_key_question_id` ON `form_item` (`form_key`, `question_id`);
```

#### 说明

- `question_id` 字段用于建立 `question` 表与 `form_item` 表的映射关系
- 这是一个逻辑外键，不使用数据库的物理外键约束
- 允许为 NULL，以兼容没有对应 question 的 form_item
- 创建索引以提高根据 questionId 查询 formItemId 的性能

## 数据迁移

如果已有数据，需要手动建立映射关系：

```sql
-- 示例：根据某种规则建立映射（需要根据实际情况调整）
-- 这里假设 formItemId 中包含 questionId 信息，或者通过其他方式建立映射
UPDATE `form_item` fi
INNER JOIN `question` q ON q.id = SUBSTRING_INDEX(fi.form_item_id, '-', -1)
SET fi.question_id = q.id
WHERE fi.question_id IS NULL;
```

## 使用说明

### 后端代码

1. **保存 FormItem 时设置 questionId**：
   ```java
   FormItem item = new FormItem();
   item.setFormKey(formKey);
   item.setFormItemId(formItemId);
   item.setQuestionId(questionId); // 设置映射关系
   // ... 其他字段
   ```

2. **根据 questionId 查询 formItemId**：
   ```java
   String formItemId = formItemService.getFormItemIdByFormKeyAndQuestionId(formKey, questionId);
   ```

3. **在 ResponseServiceImpl 中使用映射**：
   ```java
   // 提交表单时，自动将 questionId 转换为 formItemId
   String formItemId = formItemService.getFormItemIdByFormKeyAndQuestionId(
       formConfig.getFormKey(), questionId);
   ```

### 前端代码

在保存 FormItem 时，如果是从 Question 转换来的，应该传递 questionId：

```javascript
const formItem = {
  formItemId: 'radio-123456',
  type: 'RADIO',
  label: '题目标题',
  questionId: 123, // 传递 questionId 建立映射
  // ... 其他字段
}
```

## 注意事项

1. **兼容性**：如果 formItem 没有对应的 questionId，系统会使用 questionId 作为 key 保存到 form_data 表（兼容旧数据）
2. **性能**：已创建索引，查询性能良好
3. **数据一致性**：需要确保 questionId 和 formItemId 的映射关系正确建立
