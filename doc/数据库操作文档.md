# 数据库操作文档

## 一、MCP数据库连接说明

### 1.1 MCP配置信息

- **MCP名称**：`mysql-survey_analyst`
- **数据库名称**：`survey_analyst`
- **数据库类型**：MySQL 8.0+

### 1.2 连接方式

使用MCP（Model Context Protocol）进行数据库操作，通过Cursor的MCP功能连接MySQL数据库。

---

## 二、数据库表结构

### 2.1 核心数据表

#### 2.1.1 用户表 (user)

```sql
CREATE TABLE `user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `account` VARCHAR(50) NOT NULL COMMENT '账号（用于登录，唯一）',
  `email` VARCHAR(100) NOT NULL COMMENT '邮箱（用于登录，唯一）',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名（昵称，不用于登录，可重复）',
  `phone` VARCHAR(20) COMMENT '手机号',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（BCrypt加密）',
  `avatar` VARCHAR(255) COMMENT '头像URL',
  `role` VARCHAR(20) DEFAULT 'USER' COMMENT '角色：USER, ADMIN',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_account` (`account`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**字段说明**：
- `account`：用户账号，用于登录，必须唯一
- `email`：用户邮箱，用于登录，必须唯一
- `username`：用户昵称/显示名称，不用于登录，可以重复
- **登录方式**：用户可以使用账号（account）或邮箱（email）进行登录

#### 2.1.2 问卷表 (survey)

```sql
CREATE TABLE `survey` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '问卷ID',
  `user_id` BIGINT NOT NULL COMMENT '创建用户ID',
  `title` VARCHAR(200) NOT NULL COMMENT '问卷标题',
  `description` TEXT COMMENT '问卷描述',
  `status` VARCHAR(20) DEFAULT 'DRAFT' COMMENT '状态：DRAFT-草稿，PUBLISHED-已发布，PAUSED-已暂停，ENDED-已结束',
  `access_type` VARCHAR(20) DEFAULT 'PUBLIC' COMMENT '访问类型：PUBLIC-公开，PASSWORD-密码访问，PRIVATE-私有',
  `password` VARCHAR(100) COMMENT '访问密码',
  `max_responses` INT COMMENT '最大填写数',
  `start_time` DATETIME COMMENT '开始时间',
  `end_time` DATETIME COMMENT '结束时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `delete_flag` TINYINT DEFAULT 0 COMMENT '删除标志',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='问卷表';
```

#### 2.1.3 题目表 (question)

```sql
CREATE TABLE `question` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '题目ID',
  `survey_id` BIGINT NOT NULL COMMENT '问卷ID',
  `type` VARCHAR(20) NOT NULL COMMENT '题型：SINGLE_CHOICE, MULTIPLE_CHOICE, TEXT, TEXTAREA, RATING, SORT, MATRIX, FILE, DATE',
  `title` VARCHAR(500) NOT NULL COMMENT '题目标题',
  `description` TEXT COMMENT '题目描述',
  `required` TINYINT DEFAULT 0 COMMENT '是否必填：0-否，1-是',
  `order_num` INT DEFAULT 0 COMMENT '排序号',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_survey_id` (`survey_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='题目表';
```

#### 2.1.4 选项表 (option)

```sql
CREATE TABLE `option` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '选项ID',
  `question_id` BIGINT NOT NULL COMMENT '题目ID',
  `content` VARCHAR(500) NOT NULL COMMENT '选项内容',
  `image_url` VARCHAR(255) COMMENT '选项图片URL',
  `order_num` INT DEFAULT 0 COMMENT '排序号',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_question_id` (`question_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='选项表';
```

#### 2.1.5 填写记录表 (response)

```sql
CREATE TABLE `response` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '填写记录ID',
  `survey_id` BIGINT NOT NULL COMMENT '问卷ID',
  `user_id` BIGINT COMMENT '填写用户ID（匿名填写为NULL）',
  `ip_address` VARCHAR(50) COMMENT 'IP地址',
  `device_type` VARCHAR(20) COMMENT '设备类型：PC, MOBILE',
  `start_time` DATETIME COMMENT '开始填写时间',
  `submit_time` DATETIME COMMENT '提交时间',
  `duration` INT COMMENT '填写时长（秒）',
  `status` VARCHAR(20) DEFAULT 'COMPLETED' COMMENT '状态：COMPLETED-已完成，DRAFT-草稿',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_survey_id` (`survey_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='填写记录表';
```

#### 2.1.6 填写答案表 (answer)

```sql
CREATE TABLE `answer` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '答案ID',
  `response_id` BIGINT NOT NULL COMMENT '填写记录ID',
  `question_id` BIGINT NOT NULL COMMENT '题目ID',
  `option_id` BIGINT COMMENT '选项ID（选择题）',
  `content` TEXT COMMENT '答案内容（填空题）',
  `file_url` VARCHAR(255) COMMENT '文件URL（文件上传题）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_response_id` (`response_id`),
  KEY `idx_question_id` (`question_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='填写答案表';
```

---

## 三、常用数据库操作

### 3.1 查询操作

#### 3.1.1 查询所有用户

```sql
SELECT * FROM user WHERE delete_flag = 0;
```

#### 3.1.2 查询用户（按账号或邮箱）

```sql
-- 按账号查询
SELECT * FROM user WHERE account = ? AND delete_flag = 0;

-- 按邮箱查询
SELECT * FROM user WHERE email = ? AND delete_flag = 0;

-- 按账号或邮箱查询（用于登录）
SELECT * FROM user WHERE (account = ? OR email = ?) AND delete_flag = 0;
```

#### 3.1.3 查询问卷列表

```sql
-- 查询用户的所有问卷
SELECT * FROM survey WHERE user_id = ? AND delete_flag = 0 ORDER BY create_time DESC;

-- 查询已发布的问卷
SELECT * FROM survey WHERE status = 'PUBLISHED' AND delete_flag = 0;
```

#### 3.1.4 查询问卷的题目和选项

```sql
-- 查询问卷的所有题目
SELECT * FROM question WHERE survey_id = ? ORDER BY order_num;

-- 查询题目的所有选项
SELECT * FROM option WHERE question_id = ? ORDER BY order_num;
```

#### 3.1.5 查询填写记录

```sql
-- 查询问卷的所有填写记录
SELECT * FROM response WHERE survey_id = ? ORDER BY submit_time DESC;

-- 查询填写记录的答案
SELECT * FROM answer WHERE response_id = ?;
```

### 3.2 插入操作

#### 3.2.1 插入用户

```sql
INSERT INTO user (account, email, username, password, role, status) 
VALUES (?, ?, ?, ?, 'USER', 1);
```

#### 3.2.2 插入问卷

```sql
INSERT INTO survey (user_id, title, description, status) 
VALUES (?, ?, ?, 'DRAFT');
```

#### 3.2.3 插入题目

```sql
INSERT INTO question (survey_id, type, title, required, order_num) 
VALUES (?, ?, ?, ?, ?);
```

#### 3.2.4 插入选项

```sql
INSERT INTO option (question_id, content, order_num) 
VALUES (?, ?, ?);
```

#### 3.2.5 插入填写记录

```sql
INSERT INTO response (survey_id, user_id, ip_address, device_type, submit_time, status) 
VALUES (?, ?, ?, ?, NOW(), 'COMPLETED');
```

#### 3.2.6 插入答案

```sql
INSERT INTO answer (response_id, question_id, option_id, content) 
VALUES (?, ?, ?, ?);
```

### 3.3 更新操作

#### 3.3.1 更新用户信息

```sql
UPDATE user SET username = ?, avatar = ? WHERE id = ? AND delete_flag = 0;
```

#### 3.3.2 更新用户状态

```sql
UPDATE user SET status = ? WHERE id = ? AND delete_flag = 0;
```

#### 3.3.3 更新问卷状态

```sql
UPDATE survey SET status = ? WHERE id = ? AND delete_flag = 0;
```

#### 3.3.4 更新题目排序

```sql
UPDATE question SET order_num = ? WHERE id = ?;
```

### 3.4 删除操作（逻辑删除）

#### 3.4.1 删除用户

```sql
UPDATE user SET delete_flag = 1 WHERE id = ?;
```

#### 3.4.2 删除问卷

```sql
UPDATE survey SET delete_flag = 1 WHERE id = ?;
```

#### 3.4.3 删除题目

```sql
DELETE FROM question WHERE id = ?;
```

#### 3.4.4 删除选项

```sql
DELETE FROM option WHERE id = ?;
```

### 3.5 统计操作

#### 3.5.1 统计用户数

```sql
SELECT COUNT(*) FROM user WHERE delete_flag = 0;
```

#### 3.5.2 统计问卷数

```sql
SELECT COUNT(*) FROM survey WHERE delete_flag = 0;
```

#### 3.5.3 统计填写数

```sql
SELECT COUNT(*) FROM response WHERE survey_id = ?;
```

#### 3.5.4 统计选项选择数

```sql
SELECT option_id, COUNT(*) as count 
FROM answer 
WHERE question_id = ? AND option_id IS NOT NULL 
GROUP BY option_id;
```

---

## 四、使用MCP进行数据库操作

### 4.1 MCP操作步骤

1. **连接数据库**
   - 使用MCP工具连接 `mysql-survey_analyst`
   - 选择数据库 `survey_analyst`

2. **执行SQL语句**
   - 使用MCP的查询功能执行SELECT语句
   - 使用MCP的执行功能执行INSERT、UPDATE、DELETE语句

3. **查看结果**
   - MCP会返回查询结果或执行结果

### 4.2 MCP操作示例

#### 4.2.1 查询操作示例

**查询所有用户**：
```sql
SELECT id, account, email, username, role, status, create_time 
FROM user 
WHERE delete_flag = 0 
ORDER BY create_time DESC;
```

**查询问卷及其创建用户**：
```sql
SELECT s.id, s.title, s.status, u.username as creator, s.create_time
FROM survey s
LEFT JOIN user u ON s.user_id = u.id
WHERE s.delete_flag = 0
ORDER BY s.create_time DESC;
```

**查询问卷的完整信息（包含题目和选项）**：
```sql
-- 查询问卷
SELECT * FROM survey WHERE id = ?;

-- 查询题目
SELECT * FROM question WHERE survey_id = ? ORDER BY order_num;

-- 查询选项
SELECT o.* FROM option o
INNER JOIN question q ON o.question_id = q.id
WHERE q.survey_id = ?
ORDER BY q.order_num, o.order_num;
```

#### 4.2.2 插入操作示例

**创建测试用户**：
```sql
INSERT INTO user (account, email, username, password, role, status) 
VALUES ('admin', 'admin@example.com', '管理员', '$2a$10$...', 'ADMIN', 1);
```

**创建测试问卷**：
```sql
INSERT INTO survey (user_id, title, description, status) 
VALUES (1, '测试问卷', '这是一个测试问卷', 'DRAFT');
```

#### 4.2.3 更新操作示例

**更新问卷状态**：
```sql
UPDATE survey SET status = 'PUBLISHED' WHERE id = 1;
```

**更新用户信息**：
```sql
UPDATE user SET username = '新昵称', avatar = '/upload/avatar.jpg' WHERE id = 1;
```

#### 4.2.4 删除操作示例

**逻辑删除用户**：
```sql
UPDATE user SET delete_flag = 1 WHERE id = 1;
```

**逻辑删除问卷**：
```sql
UPDATE survey SET delete_flag = 1 WHERE id = 1;
```

---

## 五、数据库维护操作

### 5.1 数据备份

```sql
-- 导出用户表
SELECT * FROM user INTO OUTFILE '/backup/user.csv'
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\n';

-- 导出问卷表
SELECT * FROM survey INTO OUTFILE '/backup/survey.csv'
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\n';
```

### 5.2 数据清理

**清理已删除的用户**（物理删除，谨慎操作）：
```sql
DELETE FROM user WHERE delete_flag = 1 AND update_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

**清理过期的填写记录**：
```sql
DELETE FROM response WHERE create_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 5.3 数据统计

**系统数据统计**：
```sql
-- 总用户数
SELECT COUNT(*) as total_users FROM user WHERE delete_flag = 0;

-- 总问卷数
SELECT COUNT(*) as total_surveys FROM survey WHERE delete_flag = 0;

-- 总填写数
SELECT COUNT(*) as total_responses FROM response;

-- 今日新增用户数
SELECT COUNT(*) as today_users FROM user 
WHERE DATE(create_time) = CURDATE() AND delete_flag = 0;

-- 今日新增问卷数
SELECT COUNT(*) as today_surveys FROM survey 
WHERE DATE(create_time) = CURDATE() AND delete_flag = 0;

-- 今日填写数
SELECT COUNT(*) as today_responses FROM response 
WHERE DATE(submit_time) = CURDATE();
```

---

## 六、注意事项

1. **逻辑删除**：所有删除操作都使用逻辑删除（设置delete_flag=1），不进行物理删除
2. **唯一性约束**：账号（account）和邮箱（email）必须唯一
3. **索引使用**：查询时尽量使用索引字段（如user_id、survey_id等）
4. **事务处理**：涉及多表操作时，使用事务确保数据一致性
5. **数据备份**：定期备份重要数据
6. **性能优化**：大数据量查询时，注意使用分页和索引

---

## 七、常用查询模板

### 7.1 用户相关查询

**查询用户及其创建的问卷数**：
```sql
SELECT u.id, u.account, u.email, u.username, COUNT(s.id) as survey_count
FROM user u
LEFT JOIN survey s ON u.id = s.user_id AND s.delete_flag = 0
WHERE u.delete_flag = 0
GROUP BY u.id;
```

**查询管理员用户**：
```sql
SELECT * FROM user WHERE role = 'ADMIN' AND delete_flag = 0;
```

### 7.2 问卷相关查询

**查询问卷及其填写数**：
```sql
SELECT s.id, s.title, s.status, COUNT(r.id) as response_count
FROM survey s
LEFT JOIN response r ON s.id = r.survey_id
WHERE s.delete_flag = 0
GROUP BY s.id;
```

**查询已发布且未结束的问卷**：
```sql
SELECT * FROM survey 
WHERE status = 'PUBLISHED' 
AND (end_time IS NULL OR end_time > NOW())
AND delete_flag = 0;
```

### 7.3 数据统计查询

**查询问卷的选项统计**：
```sql
SELECT q.id as question_id, q.title as question_title,
       o.id as option_id, o.content as option_content,
       COUNT(a.id) as answer_count
FROM question q
INNER JOIN option o ON q.id = o.question_id
LEFT JOIN answer a ON o.id = a.option_id
WHERE q.survey_id = ?
GROUP BY q.id, o.id
ORDER BY q.order_num, o.order_num;
```

---

## 八、MCP操作命令参考

使用MCP进行数据库操作时，可以通过以下方式：

1. **查询数据**：使用 `mcp_mysql-survey_analyst_query` 工具
2. **执行操作**：使用 `mcp_mysql-survey_analyst_execute` 工具
3. **查看表结构**：使用 `mcp_mysql-survey_analyst_describe_table` 工具
4. **列出所有表**：使用 `mcp_mysql-survey_analyst_list_tables` 工具

**示例**：
- 查询用户：`SELECT * FROM user WHERE delete_flag = 0 LIMIT 10;`
- 插入用户：`INSERT INTO user (account, email, username, password) VALUES ('test', 'test@example.com', '测试用户', 'password');`
- 查看表结构：`DESCRIBE user;`

