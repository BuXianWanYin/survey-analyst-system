# 数据库操作文档

## 一、概述

本项目使用 **MCP (Model Context Protocol)** 来操作 MySQL 数据库。MCP 是一个标准化的协议，允许 AI 助手直接与数据库进行交互，无需手动编写 SQL 脚本。

## 二、MCP 配置

### 2.1 数据库连接信息

项目数据库 MCP 配置位于 `~/.cursor/mcp.json`：

```json
"mysql-survey_analyst": {
  "command": "npx",
  "args": ["-y", "@f4ww4z/mcp-mysql-server", "mysql://root:123456@localhost:3306/survey_analyst"]
}
```

**连接参数说明：**
- **数据库名称**: `survey_analyst`
- **主机**: `localhost`
- **端口**: `3306`
- **用户名**: `root`
- **密码**: `123456`

### 2.2 MCP 服务器标识

在使用 MCP 工具时，需要使用服务器标识：`mysql-survey_analyst`

## 三、使用 MCP 操作数据库

### 3.1 可用的 MCP 工具

MCP 提供了以下数据库操作工具：

1. **`mcp_mysql-survey_analyst_list_tables`** - 列出所有表
2. **`mcp_mysql-survey_analyst_describe_table`** - 查看表结构
3. **`mcp_mysql-survey_analyst_query`** - 执行 SELECT 查询
4. **`mcp_mysql-survey_analyst_execute`** - 执行 INSERT、UPDATE、DELETE 操作
5. **`mcp_mysql-survey_analyst_connect_db`** - 连接数据库（通常已自动连接）

### 3.2 基本操作示例

#### 3.2.1 查看所有表

**操作方式：** 在 Cursor 中直接请求 AI 助手：
```
请列出 survey_analyst 数据库中的所有表
```

AI 助手会自动调用 `mcp_mysql-survey_analyst_list_tables` 工具。

#### 3.2.2 查看表结构

**操作方式：**
```
请查看 user 表的结构
```

AI 助手会调用 `mcp_mysql-survey_analyst_describe_table` 工具，返回表的字段、类型、约束等信息。

#### 3.2.3 查询数据

**操作方式：**
```
查询所有用户信息
查询状态为已发布的问卷
查询某个用户创建的所有问卷
```

AI 助手会调用 `mcp_mysql-survey_analyst_query` 工具执行 SELECT 查询。

**示例查询：**
- `SELECT * FROM user WHERE status = 1`
- `SELECT * FROM survey WHERE status = 'PUBLISHED'`
- `SELECT * FROM survey WHERE user_id = 1 AND delete_flag = 0`

#### 3.2.4 插入数据

**操作方式：**
```
插入一条新的用户记录
插入一条新的问卷记录
```

AI 助手会调用 `mcp_mysql-survey_analyst_execute` 工具执行 INSERT 操作。

**示例：**
```sql
INSERT INTO user (account, email, username, password, role, status) 
VALUES ('test001', 'test@example.com', '测试用户', '$2a$10$...', 'USER', 1)
```

#### 3.2.5 更新数据

**操作方式：**
```
更新用户状态
更新问卷标题
```

AI 助手会调用 `mcp_mysql-survey_analyst_execute` 工具执行 UPDATE 操作。

**示例：**
```sql
UPDATE user SET status = 0 WHERE id = 1
UPDATE survey SET title = '新标题' WHERE id = 1
```

#### 3.2.6 删除数据

**操作方式：**
```
删除指定ID的用户（逻辑删除）
删除指定ID的问卷（逻辑删除）
```

**注意：** 本项目使用逻辑删除，通常通过更新 `delete_flag` 字段来实现，而不是物理删除。

**示例：**
```sql
UPDATE user SET delete_flag = 1 WHERE id = 1
UPDATE survey SET delete_flag = 1 WHERE id = 1
```

## 四、主要数据表说明

### 4.1 用户相关表

#### `user` - 用户表
- **主键**: `id`
- **主要字段**: 
  - `account` - 账号（唯一，用于登录）
  - `email` - 邮箱（唯一，用于登录）
  - `username` - 用户名（昵称）
  - `password` - 密码（BCrypt加密）
  - `role` - 角色（USER, ADMIN）
  - `status` - 状态（0-禁用，1-启用）
  - `delete_flag` - 删除标志（0-未删除，1-已删除）

### 4.2 问卷相关表

#### `survey` - 问卷表
- **主键**: `id`
- **主要字段**:
  - `user_id` - 创建用户ID
  - `title` - 问卷标题
  - `description` - 问卷描述
  - `status` - 状态（DRAFT-草稿，PUBLISHED-已发布，ENDED-已结束）
  - `access_type` - 访问类型（PUBLIC-公开，PASSWORD-密码访问，PRIVATE-私有）
  - `password` - 访问密码
  - `max_responses` - 最大填写数
  - `start_time` - 开始时间
  - `end_time` - 结束时间
  - `delete_flag` - 删除标志

#### `question` - 题目表
- **主键**: `id`
- **主要字段**:
  - `survey_id` - 问卷ID
  - `type` - 题型（SINGLE_CHOICE, MULTIPLE_CHOICE, TEXT, TEXTAREA, RATING, SORT, MATRIX, FILE, DATE）
  - `title` - 题目标题
  - `description` - 题目描述
  - `required` - 是否必填（0-否，1-是）
  - `order_num` - 排序号

#### `option` - 选项表
- **主键**: `id`
- **主要字段**:
  - `question_id` - 题目ID
  - `content` - 选项内容
  - `order_num` - 排序号

### 4.3 表单相关表

#### `form_config` - 表单配置表
- **主键**: `id`
- **主要字段**:
  - `form_key` - 表单唯一标识
  - `survey_id` - 问卷ID
  - `name` - 表单名称
  - `description` - 表单描述
  - `user_id` - 创建用户ID
  - `type` - 表单类型
  - `status` - 状态（0-禁用，1-启用）
  - `is_deleted` - 删除标志

#### `form_data` - 表单数据表
- **主键**: `id`
- **主要字段**:
  - `form_key` - 表单key
  - `serial_number` - 序号
  - `original_data` - 填写结果原始数据（JSON格式）
  - `submit_browser` - 提交浏览器
  - `submit_request_ip` - 请求IP
  - `start_time` - 开始填写时间
  - `complete_time` - 完成时间（秒）

#### `form_item` - 表单项表
- 存储表单的各个表单项配置

#### `form_template` - 表单模板表
- 存储表单模板信息

#### `form_template_category` - 表单模板分类表
- 存储表单模板分类信息

#### `form_theme` - 表单主题表
- 存储表单主题配置

#### `form_setting` - 表单设置表
- 存储表单设置信息

#### `form_logic` - 表单逻辑表
- 存储表单逻辑规则

### 4.4 响应相关表

#### `response` - 响应表
- 存储问卷响应记录

#### `answer` - 答案表
- 存储具体答案数据

### 4.5 其他表

#### `statistics_cache` - 统计缓存表
- 存储统计数据缓存

## 五、常用操作场景

### 5.1 查询操作

#### 查询所有启用的用户
```
查询所有状态为启用的用户
```

#### 查询用户创建的问卷
```
查询用户ID为1的所有已发布问卷
```

#### 查询问卷的题目
```
查询问卷ID为1的所有题目，按排序号排序
```

#### 查询表单数据
```
查询表单key为xxx的所有提交数据
```

### 5.2 数据统计

#### 统计用户数量
```
统计总共有多少个用户
```

#### 统计问卷数量
```
统计某个用户创建了多少个问卷
```

#### 统计表单提交数
```
统计某个表单的提交数量
```

### 5.3 数据维护

#### 批量更新
```
将所有草稿状态的问卷更新为已发布状态
```

#### 数据清理
```
逻辑删除30天前的测试数据
```

#### 数据备份查询
```
导出某个时间范围内的所有表单数据
```

## 六、注意事项

### 6.1 逻辑删除

本项目使用逻辑删除机制，删除操作实际上是更新 `delete_flag` 字段为 1，而不是物理删除数据。查询时需要注意过滤已删除的数据：

```sql
SELECT * FROM user WHERE delete_flag = 0
SELECT * FROM survey WHERE delete_flag = 0
```

### 6.2 密码加密

用户密码使用 BCrypt 加密存储，不能直接插入明文密码。如果需要创建测试用户，应该使用后端提供的注册接口或使用已加密的密码。

### 6.3 时间字段

时间字段使用 `LocalDateTime` 类型，格式为 `yyyy-MM-dd HH:mm:ss`。插入和更新时需要注意时间格式。

### 6.4 JSON 字段

部分表包含 JSON 格式的字段（如 `form_data.original_data`），这些字段在查询和更新时需要特殊处理。

### 6.5 外键关系

虽然数据库表之间存在逻辑外键关系，但 MySQL 中可能没有定义物理外键约束。操作时需要注意维护数据一致性。

## 七、最佳实践

1. **查询前先查看表结构**：使用 `describe_table` 了解表结构后再编写查询
2. **使用参数化查询**：避免 SQL 注入风险
3. **逻辑删除优先**：除非必要，否则使用逻辑删除而非物理删除
4. **定期备份**：重要操作前建议先查询备份数据
5. **测试环境验证**：在生产环境操作前，先在测试环境验证

## 八、故障排查

### 8.1 连接失败

如果 MCP 无法连接数据库，请检查：
- MySQL 服务是否运行
- 连接参数是否正确（用户名、密码、端口）
- 数据库 `survey_analyst` 是否存在

### 8.2 权限问题

如果遇到权限错误，请检查：
- 数据库用户是否有足够的权限
- 是否允许从 localhost 连接

### 8.3 表不存在

如果提示表不存在，请检查：
- 表名是否正确（注意大小写）
- 数据库是否已初始化
- 是否需要执行数据库迁移脚本

## 九、总结

使用 MCP 操作数据库的优势：
- ✅ **无需手动编写 SQL**：直接通过自然语言描述需求
- ✅ **自动安全检查**：MCP 工具会进行必要的安全检查
- ✅ **快速查询**：可以快速查看表结构和数据
- ✅ **交互式操作**：与 AI 助手对话即可完成数据库操作

**重要提示**：虽然 MCP 提供了便捷的数据库操作方式，但在进行重要数据修改前，请务必确认操作的正确性，建议先在测试环境验证。

